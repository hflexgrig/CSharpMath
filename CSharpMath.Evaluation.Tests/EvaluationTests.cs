using System.Linq;
using System.Text.RegularExpressions;
using AngouriMath;
using Xunit;

namespace CSharpMath.EvaluationTests {
  using Atom;

  public class EvaluationTests {
    internal static MathList ParseLaTeX(string latex) =>
      LaTeXParser.MathListFromLaTeX(latex).Match(list => list, e => throw new Xunit.Sdk.XunitException(e));
    static Evaluation.MathItem ParseMath(string latex) =>
      Evaluation.Evaluate(ParseLaTeX(latex)).Match(entity => entity, e => throw new Xunit.Sdk.XunitException(e));
    static void Test(string input, string converted, string? result) {
      void Test(string input) {
        var math = ParseMath(input);
        Assert.NotNull(math);
        Assert.Equal(converted, LaTeXParser.MathListToLaTeX(Evaluation.Visualize(math)).ToString());
        // TODO: Apparently adding this line causes a stack overflow when all tests are run, investigate later
        // Assert.Equal(converted, LaTeXParser.MathListToLaTeX(Evaluation.Visualize(ParseMath(converted))).ToString()); // Double checking conversion
        // Ensure that the converted entity is valid by simplifying it
        if (result != null)
          Assert.Equal(result,
            LaTeXParser.MathListToLaTeX(Evaluation.Visualize(Assert.IsType<Evaluation.MathItem.Entity>(math).Content.Simplify())).ToString());
        else Assert.IsNotType<Evaluation.MathItem.Entity>(result);
      }
      Test(input);
      // This regex balances (, [ and \{ with ), ] and \} into one group, then inserts \left and \right
      // But does not do this for \sqrt's [ and ]
      Test(Regex.Replace(input, @"(?<!\\sqrt)(\(|\[|\\\{)((?:(?!\(|\[|\\\\{|\)|\]|\\\\}).|(?<open>\(|\[|\\\\{)|(?<-open>\)|\]|\\\\}))+(?(open)(?!)))(\)|\]|\\\\})", @"\left$1$2\right$3"));
    }
    [Theory]
    [InlineData("1", "1", "1")]
    [InlineData("01", "1", "1")]
    [InlineData("10", "10", "10")]
    [InlineData("010", "10", "10")]
    [InlineData("1.", "1", "1")]
    [InlineData("01.", "1", "1")]
    [InlineData("1.0", "1", "1")]
    [InlineData("01.0", "1", "1")]
    [InlineData(".1", @"\frac{1}{10}", @"\frac{1}{10}")]
    [InlineData(".10", @"\frac{1}{10}", @"\frac{1}{10}")]
    [InlineData("1.1", @"\frac{11}{10}", @"\frac{11}{10}")]
    [InlineData("01.1", @"\frac{11}{10}", @"\frac{11}{10}")]
    [InlineData("1.10", @"\frac{11}{10}", @"\frac{11}{10}")]
    [InlineData("01.10", @"\frac{11}{10}", @"\frac{11}{10}")]
    [InlineData("0.1", @"\frac{1}{10}", @"\frac{1}{10}")]
    [InlineData("00.1", @"\frac{1}{10}", @"\frac{1}{10}")]
    [InlineData("0.10", @"\frac{1}{10}", @"\frac{1}{10}")]
    [InlineData("00.10", @"\frac{1}{10}", @"\frac{1}{10}")]
    [InlineData("1234", "1234", "1234")]
    [InlineData("0123456789", "123456789", "123456789")]
    [InlineData("1234.", "1234", "1234")]
    [InlineData(".5678", @"\frac{2839}{5000}", @"\frac{2839}{5000}")]
    [InlineData(".9876543210", "0.9876543210", "0.9876543210")]
    [InlineData("1234.5678", @"\frac{6172839}{5000}", @"\frac{6172839}{5000}")]
    [InlineData(@"\infty", @"\infty ", @"\infty ")]
    [InlineData(@"1_2", @"1", @"1")]
    [InlineData(@"10_2", @"2", @"2")]
    [InlineData(@"1._2", @"1", @"1")]
    [InlineData(@"1.1_2", @"\frac{3}{2}", @"\frac{3}{2}")]
    [InlineData(@".1_3", @"\frac{1}{3}", @"\frac{1}{3}")]
    [InlineData(@"10_3", @"3", @"3")]
    [InlineData(@"10.1_3", @"\frac{10}{3}", @"\frac{10}{3}")]
    public void Numbers(string input, string converted, string output) =>
      Test(input, converted, output);
    [Theory]
    [InlineData("a", "a", "a")]
    [InlineData("ab", @"ab", @"ab")]
    [InlineData("abc", @"abc", @"abc")]
    [InlineData("3a", @"3a", @"3a")]
    [InlineData("3ab", @"3ab", @"3ab")]
    [InlineData("3a3", @"3a\cdot 3", @"9a")]
    [InlineData("3aa", @"3aa", @"3a^2")]
    [InlineData(@"3\mathrm{aa}", @"3\mathrm{aa}", @"3\mathrm{aa}")]
    [InlineData(@"3\mathrm{aa}a", @"3\mathrm{aa}a", @"3a\mathrm{aa}")]
    [InlineData(@"3\mathrm{a}a", @"3aa", @"3a^2")]
    [InlineData(@"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
      @"abcd\mathrm{e}fgh\cdot \mathrm{i}jklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
      // i is considered as a number instead of a variable, unlike other alphabets, so it is sorted to the front
      @"\mathrm{i}aAbBcCdD\mathrm{e}EfFgGhHIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ")]
    [InlineData(@"\alpha\beta\gamma\delta\epsilon\varepsilon\zeta\eta\theta\iota\kappa\varkappa" +
      @"\lambda\mu\nu\xi\omicron\pi\varpi\rho\varrho\sigma\varsigma\tau\upsilon\phi\varphi\chi" +
      @"\psi\omega\Gamma\Delta\Theta\Lambda\Xi\Pi\Sigma\Upsilon\Phi\Psi\Omega",
      @"\alpha \beta \gamma \delta \epsilon \varepsilon \zeta " +
      @"\eta \theta \iota \kappa \varkappa \lambda \mu " +
      @"\nu \xi \omicron \mathrm{\pi }\varpi \rho \varrho " +
      @"\sigma \varsigma \tau \upsilon \phi \varphi \chi " +
      @"\psi \omega \Gamma \Delta \Theta \Lambda \Xi " +
      @"\Pi \Sigma \Upsilon \Phi \Psi \Omega ",
      @"\alpha \beta \chi \delta \Delta \epsilon \eta " +
      @"\gamma \Gamma \iota \kappa \lambda \Lambda \mu " +
      @"\nu \omega \Omega \omicron \phi \Phi \mathrm{\pi }\Pi " +
      @"\psi \Psi \rho \sigma \Sigma \tau \theta " +
      @"\Theta \upsilon \Upsilon \varepsilon \varkappa \varphi " +
      @"\varpi \varrho \varsigma \xi \Xi \zeta ")]
    [InlineData(@"a_2", @"a_2", @"a_2")]
    [InlineData(@"a_2+a_2", @"a_2+a_2", @"2a_2")]
    [InlineData(@"a_{23}", @"a_{\mathrm{23}}", @"a_{\mathrm{23}}")]
    [InlineData(@"\pi_a", @"\mathrm{\pi _{\mathnormal{a}}}", @"\mathrm{\pi _{\mathnormal{a}}}")]
    [InlineData(@"\pi_\kappa", @"\mathrm{\pi _{\mathnormal{\kappa }}}", @"\mathrm{\pi _{\mathnormal{\kappa }}}")]
    [InlineData(@"\pi_{\kappa23}", @"\mathrm{\pi _{\kappa 23}}", @"\mathrm{\pi _{\kappa 23}}")]
    [InlineData(@"\pi_{1a\kappa23}", @"\mathrm{\pi _{1a\kappa 23}}", @"\mathrm{\pi _{1a\kappa 23}}")]
    [InlineData(@"ii", @"\mathrm{i}\cdot \mathrm{i}", @"-1")]
    [InlineData(@"i\infty", @"\mathrm{i}\cdot \infty ", @"\infty \mathrm{i}")]
    [InlineData(@"\infty\infty", @"\infty \cdot \infty ", @"\infty ")]
    [InlineData(@"\theta θ \mathrm{theta\ θ}", @"\theta \theta \theta \theta ", @"\theta ^4")]
    [InlineData(@"\theta_\theta\theta_θθ_\mathrm{theta}\mathrm{theta_θ}\mathrm{θ}_{theta}", @"\theta _{\theta }\theta _{\theta }\theta _{\theta }\theta _{\theta }\theta _{\theta }", @"\theta _{\theta }^5")]
    public void Variables(string input, string converted, string result) => Test(input, converted, result);
    [Theory]
    [InlineData("a + b", @"a+b", "a+b")]
    [InlineData("a - b", @"a-b", "a-b")]
    [InlineData(@"a\times b", @"ab", @"ab")]
    [InlineData(@"a\cdot b", @"ab", @"ab")]
    [InlineData(@"a / b", @"\frac{a}{b}", @"\frac{a}{b}")]
    [InlineData(@"a\div b", @"\frac{a}{b}", @"\frac{a}{b}")]
    [InlineData(@"\frac ab", @"\frac{a}{b}", @"\frac{a}{b}")]
    [InlineData(@"a + b + c", @"a+b+c", "a+b+c")]
    [InlineData(@"a + b - c", @"a+b-c", "a+b-c")]
    [InlineData(@"a + b \times c", @"a+bc", @"a+bc")]
    [InlineData(@"a + b \cdot c", @"a+bc", @"a+bc")]
    [InlineData(@"a + b / c", @"a+\frac{b}{c}", @"a+\frac{b}{c}")]
    [InlineData(@"a - b + c", @"a-b+c", "a-b+c")]
    [InlineData(@"a - b - c", @"a-b-c", @"a-b-c")]
    [InlineData(@"a - b \times c", @"a-bc", @"a-bc")]
    [InlineData(@"a - b / c", @"a-\frac{b}{c}", @"a-\frac{b}{c}")]
    [InlineData(@"a \times b + c", @"ab+c", @"ab+c")]
    [InlineData(@"a \times b - c", @"ab-c", @"ab-c")]
    [InlineData(@"a \times b \times c", @"abc", @"abc")]
    [InlineData(@"a \times b / c", @"\frac{ab}{c}", @"\frac{ab}{c}")]
    [InlineData(@"a \cdot b + c", @"ab+c", @"ab+c")]
    [InlineData(@"a \cdot b - c", @"ab-c", @"ab-c")]
    [InlineData(@"a \cdot b \times c", @"abc", @"abc")]
    [InlineData(@"a \times b \cdot c", @"abc", @"abc")]
    [InlineData(@"a \cdot b \cdot c", @"abc", @"abc")]
    [InlineData(@"a \cdot bc", @"abc", @"abc")]
    [InlineData(@"a \cdot b / c", @"\frac{ab}{c}", @"\frac{ab}{c}")]
    [InlineData(@"a / b + c", @"\frac{a}{b}+c", @"\frac{a}{b}+c")]
    [InlineData(@"a / b - c", @"\frac{a}{b}-c", @"\frac{a}{b}-c")]
    [InlineData(@"a / b \times c", @"\frac{a}{b}\cdot c", @"\frac{a}{b}\cdot c")]
    [InlineData(@"a / b \cdot c", @"\frac{a}{b}\cdot c", @"\frac{a}{b}\cdot c")]
    [InlineData(@"a / b / c", @"\frac{\frac{a}{b}}{c}", @"\frac{a}{bc}")]
    [InlineData(@"2+\frac ab", @"2+\frac{a}{b}", @"2+\frac{a}{b}")]
    [InlineData(@"\frac ab+2", @"\frac{a}{b}+2", @"\frac{a}{b}+2")]
    [InlineData(@"2-\frac ab", @"2-\frac{a}{b}", @"2-\frac{a}{b}")]
    [InlineData(@"\frac ab-2", @"\frac{a}{b}-2", @"\frac{a}{b}-2")]
    [InlineData(@"2\times\frac ab", @"2\cdot \frac{a}{b}", @"2\cdot \frac{a}{b}")]
    [InlineData(@"2\cdot\frac ab", @"2\cdot \frac{a}{b}", @"2\cdot \frac{a}{b}")]
    [InlineData(@"\frac ab\times 2", @"\frac{a}{b}\cdot 2", @"\frac{a}{b}\cdot 2")]
    [InlineData(@"\frac ab\cdot 2", @"\frac{a}{b}\cdot 2", @"\frac{a}{b}\cdot 2")]
    [InlineData(@"2/\frac ab", @"\frac{2}{\frac{a}{b}}", @"\frac{2b}{a}")]
    [InlineData(@"\frac ab/2", @"\frac{\frac{a}{b}}{2}", @"\frac{a}{2b}")]
    [InlineData(@"1+\mathrm{i}", @"1+\mathrm{i}", @"1+\mathrm{i}")]
    [InlineData(@"1-\mathrm{i}", @"1-\mathrm{i}", @"1-\mathrm{i}")]
    [InlineData(@"\mathrm{i}+1", @"\mathrm{i}+1", @"1+\mathrm{i}")]
    [InlineData(@"\mathrm{i}-1", @"\mathrm{i}-1", @"-1+\mathrm{i}")]
    [InlineData(@"\infty+1", @"\infty +1", @"\infty ")]
    [InlineData(@"\infty+\mathrm{i}", @"\infty +\mathrm{i}", @"\infty +\mathrm{i}")]
    [InlineData(@"\infty+\infty", @"\infty +\infty ", @"\infty ")]
    [InlineData(@"\infty\times \infty", @"\infty \cdot \infty ", @"\infty ")]
    [InlineData(@"\infty\cdot \infty", @"\infty \cdot \infty ", @"\infty ")]
    [InlineData(@"\mathrm{i}\times \infty", @"\mathrm{i}\cdot \infty ", @"\infty \mathrm{i}")]
    [InlineData(@"\mathrm{i}\cdot \infty", @"\mathrm{i}\cdot \infty ", @"\infty \mathrm{i}")]
    [InlineData(@"\infty\times \mathrm{i}", @"\infty \cdot \mathrm{i}", @"\infty \mathrm{i}")]
    [InlineData(@"\mathrm{i}\times \mathrm{i}", @"\mathrm{i}\cdot \mathrm{i}", @"-1")]
    [InlineData(@"\frac00", @"\frac{0}{0}", @"\mathrm{undefined}")]
    [InlineData(@"\frac xx", @"\frac{x}{x}", @"1\quad \mathrm{for}\quad x\neq 0")]
    [InlineData(@"\frac xx+1", @"\frac{x}{x}+1", @"2\quad \mathrm{for}\quad x\neq 0")]
    [InlineData(@"\frac0\infty", @"\frac{0}{\infty }", @"0")]
    [InlineData(@"\frac2\infty", @"\frac{2}{\infty }", @"0")]
    [InlineData(@"\frac{-2}\infty", @"\frac{-2}{\infty }", @"0")]
    [InlineData(@"\frac20", @"\frac{2}{0}", @"\mathrm{undefined}")]
    [InlineData(@"\frac{-2}0", @"\frac{-2}{0}", @"\mathrm{undefined}")]
    [InlineData(@"\frac\infty0", @"\frac{\infty }{0}", @"\mathrm{undefined}")]
    [InlineData(@"\frac{-\infty}0", @"\frac{-\infty }{0}", @"\mathrm{undefined}")]
    [InlineData(@"\frac\infty\infty", @"\frac{\infty }{\infty }", @"\mathrm{undefined}")]
    [InlineData(@"\frac{-\infty}{\infty}", @"\frac{-\infty }{\infty }", @"\mathrm{undefined}")]
    [InlineData(@"a / bc", @"\frac{a}{bc}", @"\frac{a}{bc}")]
    [InlineData(@"a / bc / d", @"\frac{\frac{a}{bc}}{d}", @"\frac{a}{bcd}")]
    [InlineData(@"-2/\sin x/y", @"\frac{\frac{-2}{\sin \left( x\right) }}{y}", @"\frac{-2}{\sin \left( x\right) \cdot y}")]
    public void BinaryOperators(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"+i", @"\mathrm{i}", @"\mathrm{i}")]
    [InlineData(@"-i", @"-\mathrm{i}", @"-\mathrm{i}")]
    [InlineData("+a", "a", "a")]
    [InlineData("-a", "-a", "-a")]
    [InlineData("++a", "a", "a")]
    [InlineData("+-a", "-a", "-a")]
    [InlineData("-+a", "-a", "-a")]
    [InlineData("--a", @"-\left( -1\right) \cdot a", "a")]
    [InlineData("+++a", "a", "a")]
    [InlineData("---a", @"-\left( -1\right) \left( -1\right) \cdot a", "-a")]
    [InlineData("a++a", "a+a", @"2a")]
    [InlineData("a+-a", "a-a", "0")]
    [InlineData("a-+a", "a-a", "0")]
    [InlineData("a--a", @"a--a", @"2a")]
    [InlineData("a+++a", "a+a", @"2a")]
    [InlineData("a---a", @"a--\left( -1\right) \cdot a", "0")]
    [InlineData(@"a\times+a", @"aa", "a^2")]
    [InlineData(@"a\times-a", @"a\left( -1\right) \cdot a", "-a^2")]
    [InlineData(@"+a\times+a", @"aa", "a^2")]
    [InlineData(@"-a\times-a", @"-a\left( -1\right) \cdot a", "a^2")]
    [InlineData("a/+a", @"\frac{a}{a}", @"1\quad \mathrm{for}\quad a\neq 0")]
    [InlineData("a/-a", @"\frac{a}{-a}", @"-1\quad \mathrm{for}\quad a\neq 0")]
    [InlineData("+a/+a", @"\frac{a}{a}", @"1\quad \mathrm{for}\quad a\neq 0")]
    [InlineData("-a/-a", @"\frac{-a}{-a}", @"1\quad \mathrm{for}\quad a\neq 0")]
    [InlineData(@"-2+-2+-2", @"-2-2-2", "-6")]
    [InlineData(@"-2--2--2", @"-2--2--2", "2")]
    [InlineData(@"-2\times -2\times -2", @"-2\left( -1\right) \cdot 2\left( -1\right) \cdot 2", "-8")]
    [InlineData(@"-2/-2/-2", @"\frac{\frac{-2}{-2}}{-2}", @"\frac{-1}{2}")]
    public void UnaryOperators(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"9\%", @"\frac{9}{100}", @"\frac{9}{100}")]
    [InlineData(@"a\%", @"\frac{a}{100}", @"\frac{a}{100}")]
    [InlineData(@"\pi\%", @"\frac{\mathrm{\pi }}{100}", @"\frac{\mathrm{\pi }}{100}")]
    [InlineData(@"a\%\%", @"\frac{\frac{a}{100}}{100}", @"\frac{a}{10000}")]
    [InlineData(@"9\%+3", @"\frac{9}{100}+3", @"\frac{309}{100}")]
    [InlineData(@"-9\%+3", @"-\frac{9}{100}+3", @"\frac{291}{100}")]
    [InlineData(@"2^2\%", @"\frac{2^2}{100}", @"\frac{1}{25}")]
    [InlineData(@"2\%^2", @"\left( \frac{2}{100}\right) ^2", @"\frac{1}{2500}")]
    [InlineData(@"2\%2", @"\frac{2}{100}\cdot 2", @"\frac{1}{25}")]
    [InlineData(@"1+2\%^2", @"1+\left( \frac{2}{100}\right) ^2", @"\frac{2501}{2500}")]
    [InlineData(@"9\degree", @"\frac{9\mathrm{\pi }}{180}", @"\frac{\mathrm{\pi }}{20}")]
    [InlineData(@"a\degree", @"\frac{a\mathrm{\pi }}{180}", @"\frac{a\mathrm{\pi }}{180}")]
    [InlineData(@"\pi\degree", @"\frac{\mathrm{\pi }\cdot \mathrm{\pi }}{180}", @"\frac{\mathrm{\pi ^{\mathnormal{2}}}}{180}")]
    [InlineData(@"a\%\degree", @"\frac{\frac{a}{100}\cdot \mathrm{\pi }}{180}", @"\frac{a\mathrm{\pi }}{18000}")]
    [InlineData(@"a\degree\degree", @"\frac{\frac{a\mathrm{\pi }}{180}\cdot \mathrm{\pi }}{180}", @"\frac{a\mathrm{\pi ^{\mathnormal{2}}}}{32400}")]
    [InlineData(@"9\degree+3", @"\frac{9\mathrm{\pi }}{180}+3", @"3+\frac{\mathrm{\pi }}{20}")]
    [InlineData(@"-9\degree+3", @"-\frac{9\mathrm{\pi }}{180}+3", @"3+\frac{-1}{20}\cdot \mathrm{\pi }")]
    [InlineData(@"2^2\degree", @"\frac{2^2\cdot \mathrm{\pi }}{180}", @"\frac{\mathrm{\pi }}{45}")]
    [InlineData(@"2\degree^2", @"\left( \frac{2\mathrm{\pi }}{180}\right) ^2", @"\frac{\mathrm{\pi ^{\mathnormal{2}}}}{8100}")]
    [InlineData(@"2\degree2", @"\frac{2\mathrm{\pi }}{180}\cdot 2", @"\frac{\mathrm{\pi }}{45}")]
    [InlineData(@"1+2\degree^2", @"1+\left( \frac{2\mathrm{\pi }}{180}\right) ^2", @"1+\frac{\mathrm{\pi ^{\mathnormal{2}}}}{8100}")]
    [InlineData(@"0!", @"0!", @"1")]
    [InlineData(@"2.5!", @"\left( \frac{5}{2}\right) !", @"\frac{15}{8}\cdot \sqrt{\mathrm{\pi }}")]
    [InlineData(@"-1!", @"-1!", @"-1")]
    [InlineData(@"(-1)!", @"\left( -1\right) !", @"\mathrm{undefined}")]
    [InlineData(@"(-1)!!", @"2^{\frac{-1}{2}}\left( \frac{2}{\mathrm{\pi }}\right) ^{\frac{1-\cos \left( \mathrm{\pi }\left( -1\right) \cdot 1\right) }{4}}\cdot \left( \frac{-1}{2}\right) !", @"1")]
    [InlineData(@"(-1)!!!", @"\left( 2^{\frac{-1}{2}}\left( \frac{2}{\mathrm{\pi }}\right) ^{\frac{1-\cos \left( \mathrm{\pi }\left( -1\right) \cdot 1\right) }{4}}\cdot \left( \frac{-1}{2}\right) !\right) !", @"1")]
    public void PostfixOperators(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData("0", "1")]
    [InlineData("1", "1")]
    [InlineData("2", "2")]
    [InlineData("3", "3")]
    [InlineData("30", "42849873690624000")]
    [InlineData("31", "191898783962510625")]
    [InlineData(@"\frac{25}{2}", @"\sqrt[4]{2}^{25}\sqrt[4]{\frac{2}{\mathrm{\pi }}}\cdot \left( \frac{25}{4}\right) !")]
    public void DoubleFactorial(string x, string result) => Test($"{x}!!", $$$"""2^{\frac{{{{x}}}}{2}}\left( \frac{2}{\mathrm{\pi }}\right) ^{\frac{1-\cos \left( \mathrm{\pi }{{{(x == @"\frac{25}{2}" ? "" : @"\cdot ")}}}{{{x}}}\right) }{4}}\cdot \left( \frac{{{{x}}}}{2}\right) !""", result);
    [Theory]
    [InlineData(@"2^2", "2^2", "4")]
    [InlineData(@".2^2", @"\left( \frac{1}{5}\right) ^2", @"\frac{1}{25}")]
    [InlineData(@"2.^2", "2^2", "4")]
    [InlineData(@"2.1^2", @"\left( \frac{21}{10}\right) ^2", @"\frac{441}{100}")]
    [InlineData(@"a^a", "a^a", "a^a")]
    [InlineData(@"a^{a+b}", "a^{a+b}", "a^{a+b}")]
    [InlineData(@"a^{-2}", "a^{-2}", @"\frac{1}{a^2}")]
    [InlineData(@"2^{3^4}", "2^{3^4}", "2417851639229258349412352")]
    [InlineData(@"4^{3^2}", "4^{3^2}", "262144")]
    [InlineData(@"4^3+2", "4^3+2", "66")]
    [InlineData(@"2+3^4", "2+3^4", "83")]
    [InlineData(@"4^3\cdot2", @"4^3\cdot 2", "128")]
    [InlineData(@"2\times3^4", @"2\cdot 3^4", "162")]
    [InlineData(@"1/x", @"\frac{1}{x}", @"\frac{1}{x}")]
    [InlineData(@"2/x", @"\frac{2}{x}", @"\frac{2}{x}")]
    [InlineData(@"0^x", @"0^x", @"0\quad \mathrm{for}\quad \left( 1+\frac{1}{\operatorname{sgn} \left( x\right) ^2}\right) \cdot x>0")]
    [InlineData(@"1^x", @"1^x", @"1")]
    [InlineData(@"x^0", @"x^0", @"1\quad \mathrm{for}\quad x\neq 0")]
    [InlineData(@"x^{-1}", @"x^{-1}", @"\frac{1}{x}")]
    [InlineData(@"-i^{-1}", @"-\mathrm{i^{\mathnormal{-1}}}", @"\mathrm{i}")]
    [InlineData(@"i^{-2}", @"\mathrm{i^{\mathnormal{-2}}}", @"-1")]
    [InlineData(@"i^{-1}", @"\mathrm{i^{\mathnormal{-1}}}", @"-\mathrm{i}")]
    [InlineData(@"i^0", @"\mathrm{i^{\mathnormal{0}}}", @"1")]
    [InlineData(@"i^1", @"\mathrm{i^{\mathnormal{1}}}", @"\mathrm{i}")]
    [InlineData(@"i^2", @"\mathrm{i^{\mathnormal{2}}}", @"-1")]
    [InlineData(@"i^3", @"\mathrm{i^{\mathnormal{3}}}", @"-\mathrm{i}")]
    [InlineData(@"i^4", @"\mathrm{i^{\mathnormal{4}}}", @"1")]
    [InlineData(@"i^5", @"\mathrm{i^{\mathnormal{5}}}", @"\mathrm{i}")]
    [InlineData(@"\mathrm{-i^{\mathit -1}}", @"-\mathrm{i^{\mathnormal{-1}}}", @"\mathrm{i}")]
    [InlineData(@"\mathrm{i^{-2}}", @"\mathrm{i^{\mathnormal{-2}}}", @"-1")]
    [InlineData(@"\mathrm i^{-1}", @"\mathrm{i^{\mathnormal{-1}}}", @"-\mathrm{i}")]
    [InlineData(@"\mathrm{i^0}", @"\mathrm{i^{\mathnormal{0}}}", @"1")]
    [InlineData(@"\mathrm{i^1}", @"\mathrm{i^{\mathnormal{1}}}", @"\mathrm{i}")]
    [InlineData(@"\mathrm{i^{\mathnormal 2}}", @"\mathrm{i^{\mathnormal{2}}}", @"-1")]
    [InlineData(@"\mathrm{i^3}", @"\mathrm{i^{\mathnormal{3}}}", @"-\mathrm{i}")]
    [InlineData(@"\mathrm{i^{\mathnormal{4}}}", @"\mathrm{i^{\mathnormal{4}}}", @"1")]
    [InlineData(@"\mathrm{i^5}", @"\mathrm{i^{\mathnormal{5}}}", @"\mathrm{i}")]
    [InlineData(@"\mathrm{zz^2}", @"\mathrm{zz^{\mathnormal{2}}}", @"\mathrm{zz^{\mathnormal{2}}}")]
    [InlineData(@"\mathrm{zz^{aa}}", @"\mathrm{zz^{aa}}", @"\mathrm{zz^{aa}}")]
    [InlineData(@"\mathrm{zz^{aa\mathnormal{a}}}", @"\mathrm{zz^{aa\mathnormal{a}}}", @"\mathrm{zz^{\mathnormal{a}aa}}")]
    [InlineData(@"\mathrm{zz^{aa\cdot aa}}", @"\mathrm{zz^{aa\mathnormal{\cdot }aa}}", @"\mathrm{zz^{aa^{\mathnormal{2}}}}")]
    [InlineData(@"\mathrm{a^2a^2ab}", @"a^2a^2\cdot \mathrm{ab}", @"a^4\cdot \mathrm{ab}")]
    [InlineData(@"\mathrm{a_2a_2ab}", @"a_2a_2\mathrm{ab}", @"a_2^2\cdot \mathrm{ab}")]
    [InlineData(@"\mathrm{a^2_2a_2^2ab}", @"a_2^2a_2^2\cdot \mathrm{ab}", @"a_2^4\cdot \mathrm{ab}")]
    [InlineData(@"\mathrm{ab^2ab_2ab}", @"\mathrm{ab^{\mathnormal{2}}}\cdot \mathrm{ab_{\mathnormal{2}}}\cdot \mathrm{ab}", @"\mathrm{ab^{\mathnormal{3}}}\cdot \mathrm{ab_{\mathnormal{2}}}")]
    [InlineData(@"10^2", @"10^2", @"100")]
    [InlineData(@".1^2", @"\left( \frac{1}{10}\right) ^2", @"\frac{1}{100}")]
    [InlineData(@"10^x", @"10^x", @"10^x")]
    [InlineData(@"{\frac 12}^4", @"\left( \frac{1}{2}\right) ^4", @"\frac{1}{16}")]
    [InlineData(@"\sqrt2", @"\sqrt{2}", @"\sqrt{2}")]
    [InlineData(@"\sqrt2^2", @"\left( \sqrt{2}\right) ^2", "2")]
    [InlineData(@"\sqrt[3]2", @"2^{\frac{1}{3}}", @"\sqrt[3]{2}")]
    [InlineData(@"\sqrt[3/2]2", @"2^{\frac{1}{\frac{3}{2}}}", @"\sqrt[3]{2}^2")]
    [InlineData(@"\sqrt[3]2^3", @"\left( 2^{\frac{1}{3}}\right) ^3", "2")]
    [InlineData(@"\sqrt[3]2^{1+1+1}", @"\left( 2^{\frac{1}{3}}\right) ^{1+1+1}", "2")]
    [InlineData(@"\sqrt[1+1+1]2^{1+1+1}", @"\left( 2^{\frac{1}{1+1+1}}\right) ^{1+1+1}", "2")]
    public void Exponents(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\sin x", @"\sin \left( x\right) ", @"\sin \left( x\right) ")]
    [InlineData(@"\cos x", @"\cos \left( x\right) ", @"\cos \left( x\right) ")]
    [InlineData(@"\tan x", @"\tan \left( x\right) ", @"\tan \left( x\right) ")]
    [InlineData(@"\cot x", @"\cot \left( x\right) ", @"\cot \left( x\right) ")]
    [InlineData(@"\sec x", @"\sec \left( x\right) ", @"\sec \left( x\right) ")]
    [InlineData(@"\csc x", @"\csc \left( x\right) ", @"\csc \left( x\right) ")]
    [InlineData(@"\arcsin x", @"\arcsin \left( x\right) ", @"\arcsin \left( x\right) ")]
    [InlineData(@"\arccos x", @"\arccos \left( x\right) ", @"\arccos \left( x\right) ")]
    [InlineData(@"\arctan x", @"\arctan \left( x\right) ", @"\arctan \left( x\right) ")]
    [InlineData(@"\arccot x", @"\arccot \left( x\right) ", @"\arccot \left( x\right) ")]
    [InlineData(@"\arcsec x", @"\arcsec \left( x\right) ", @"\arcsec \left( x\right) ")]
    [InlineData(@"\arccsc x", @"\arccsc \left( x\right) ", @"\arccsc \left( x\right) ")]
    [InlineData(@"\ln x", @"\ln \left( x\right) ", @"\ln \left( x\right) ")]
    [InlineData(@"\log x", @"\log \left( x\right) ", @"\log \left( x\right) ")]
    [InlineData(@"\log_3 x", @"\log _3\left( x\right) ", @"\log _3\left( x\right) ")]
    [InlineData(@"\log_{10} x", @"\log \left( x\right) ", @"\log \left( x\right) ")]
    [InlineData(@"\log_e x", @"\ln \left( x\right) ", @"\ln \left( x\right) ")]
    [InlineData(@"\ln x^2", @"\ln \left( x^2\right) ", @"\ln \left( x^2\right) ")]
    [InlineData(@"\log x^2", @"\log \left( x^2\right) ", @"\log \left( x^2\right) ")]
    [InlineData(@"\log_{10} x^2", @"\log \left( x^2\right) ", @"\log \left( x^2\right) ")]
    [InlineData(@"\log_3 x^2", @"\log _3\left( x^2\right) ", @"\log _3\left( x^2\right) ")]
    [InlineData(@"\log_e x^2", @"\ln \left( x^2\right) ", @"\ln \left( x^2\right) ")]
    [InlineData(@"\ln x^{-1}", @"\ln \left( x^{-1}\right) ", @"\ln \left( \frac{1}{x}\right) ")]
    [InlineData(@"\log x^{-1}", @"\log \left( x^{-1}\right) ", @"\log \left( \frac{1}{x}\right) ")]
    [InlineData(@"\log_{10} x^{-1}", @"\log \left( x^{-1}\right) ", @"\log \left( \frac{1}{x}\right) ")]
    [InlineData(@"\log_3 x^{-1}", @"\log _3\left( x^{-1}\right) ", @"\log _3\left( \frac{1}{x}\right) ")]
    [InlineData(@"\log_e x^{-1}", @"\ln \left( x^{-1}\right) ", @"\ln \left( \frac{1}{x}\right) ")]
    [InlineData(@"2\sin x", @"2\sin \left( x\right) ", @"2\sin \left( x\right) ")]
    [InlineData(@"\sin 2x", @"\sin \left( 2x\right) ", @"\sin \left( 2x\right) ")]
    [InlineData(@"\sin x2", @"\sin \left( x\cdot 2\right) ", @"\sin \left( 2x\right) ")]
    [InlineData(@"\sin x2^2", @"\sin \left( x\cdot 2^2\right) ", @"\sin \left( 4x\right) ")]
    [InlineData(@"\sin xy", @"\sin \left( xy\right) ", @"\sin \left( xy\right) ")]
    [InlineData(@"\sin \frac\pi2", @"\sin \left( \frac{\mathrm{\pi }}{2}\right) ", @"1")]
    [InlineData(@"\sin \frac\pi2+1", @"\sin \left( \frac{\mathrm{\pi }}{2}\right) +1", @"2")]
    [InlineData(@"\cos +x", @"\cos \left( x\right) ", @"\cos \left( x\right) ")]
    [InlineData(@"\cos -x", @"\cos \left( -x\right) ", @"\cos \left( -x\right) ")]
    [InlineData(@"\tan x\%", @"\tan \left( \frac{x}{100}\right) ", @"\tan \left( \frac{x}{100}\right) ")]
    [InlineData(@"\tan x\%^2", @"\tan \left( \left( \frac{x}{100}\right) ^2\right) ", @"\tan \left( \left( \frac{x}{100}\right) ^2\right) ")]
    [InlineData(@"\cot x\times y", @"\cot \left( x\right) \cdot y", @"\cot \left( x\right) \cdot y")]
    [InlineData(@"\cot x/y", @"\frac{\cot \left( x\right) }{y}", @"\frac{\cot \left( x\right) }{y}")]
    [InlineData(@"\cos \arccos x", @"\cos \left( \arccos \left( x\right) \right) ", @"x")]
    [InlineData(@"\sin^2 x", @"\sin \left( x\right) ^2", @"\sin \left( x\right) ^2")]
    [InlineData(@"\sin^2 xy+\cos^2 yx", @"\sin \left( xy\right) ^2+\cos \left( yx\right) ^2", @"1")]
    [InlineData(@"\log^2 x", @"\log \left( x\right) ^2", @"\log \left( x\right) ^2")]
    [InlineData(@"\ln^2 x", @"\ln \left( x\right) ^2", @"\ln \left( x\right) ^2")]
    [InlineData(@"\log_{10}^2 x", @"\log \left( x\right) ^2", @"\log \left( x\right) ^2")]
    [InlineData(@"\log_3^2 x", @"\log _3\left( x\right) ^2", @"\log _3\left( x\right) ^2")]
    public void Functions(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\sin^{-1} x", @"\arcsin \left( x\right) ", @"\arcsin \left( x\right) ")]
    [InlineData(@"\cos^{-1} x", @"\arccos \left( x\right) ", @"\arccos \left( x\right) ")]
    [InlineData(@"\tan^{-1} x", @"\arctan \left( x\right) ", @"\arctan \left( x\right) ")]
    [InlineData(@"\cot^{-1} x", @"\arccot \left( x\right) ", @"\arccot \left( x\right) ")]
    [InlineData(@"\sec^{-1} x", @"\arcsec \left( x\right) ", @"\arcsec \left( x\right) ")]
    [InlineData(@"\csc^{-1} x", @"\arccsc \left( x\right) ", @"\arccsc \left( x\right) ")]
    [InlineData(@"\arcsin^{-1} x", @"\sin \left( x\right) ", @"\sin \left( x\right) ")]
    [InlineData(@"\arccos^{-1} x", @"\cos \left( x\right) ", @"\cos \left( x\right) ")]
    [InlineData(@"\arctan^{-1} x", @"\tan \left( x\right) ", @"\tan \left( x\right) ")]
    [InlineData(@"\arccot^{-1} x", @"\cot \left( x\right) ", @"\cot \left( x\right) ")]
    [InlineData(@"\arcsec^{-1} x", @"\sec \left( x\right) ", @"\sec \left( x\right) ")]
    [InlineData(@"\arccsc^{-1} x", @"\csc \left( x\right) ", @"\csc \left( x\right) ")]
    [InlineData(@"\ln^{-1} x", @"\mathrm{e^{\mathnormal{x}}}", @"\mathrm{e^{\mathnormal{x}}}")]
    [InlineData(@"\log^{-1} x", @"10^x", @"10^x")]
    [InlineData(@"\log_3^{-1} x", @"3^x", @"3^x")]
    [InlineData(@"\log^{-1}_{10} x", @"10^x", @"10^x")]
    [InlineData(@"\log_e^{-1} x", @"\mathrm{e^{\mathnormal{x}}}", @"\mathrm{e^{\mathnormal{x}}}")]
    [InlineData(@"\ln^{-1} x^2", @"\mathrm{e^{\mathnormal{x^2}}}", @"\mathrm{e^{\mathnormal{x^2}}}")]
    [InlineData(@"\log^{-1} x^2", @"10^{x^2}", @"10^{x^2}")]
    [InlineData(@"\log_{10}^{-1} x^2", @"10^{x^2}", @"10^{x^2}")]
    [InlineData(@"\log_3^{-1} x^2", @"3^{x^2}", @"3^{x^2}")]
    [InlineData(@"\log_e^{-1} x^2", @"\mathrm{e^{\mathnormal{x^2}}}", @"\mathrm{e^{\mathnormal{x^2}}}")]
    [InlineData(@"\ln^{-1} x^{-1}", @"\mathrm{e^{\mathnormal{x^{-1}}}}", @"\mathrm{e^{\mathnormal{\frac{1}{x}}}}")]
    [InlineData(@"\log^{-1} x^{-1}", @"10^{x^{-1}}", @"10^{\frac{1}{x}}")]
    [InlineData(@"\log_{10}^{-1} x^{-1}", @"10^{x^{-1}}", @"10^{\frac{1}{x}}")]
    [InlineData(@"\log_3^{-1} x^{-1}", @"3^{x^{-1}}", @"3^{\frac{1}{x}}")]
    [InlineData(@"\log_e^{-1} x^{-1}", @"\mathrm{e^{\mathnormal{x^{-1}}}}", @"\mathrm{e^{\mathnormal{\frac{1}{x}}}}")]
    [InlineData(@"2\sin^{-1} x", @"2\arcsin \left( x\right) ", @"2\arcsin \left( x\right) ")]
    [InlineData(@"\sin^{-1} 2x", @"\arcsin \left( 2x\right) ", @"\arcsin \left( 2x\right) ")]
    [InlineData(@"\sin^{-1} xy", @"\arcsin \left( xy\right) ", @"\arcsin \left( xy\right) ")]
    [InlineData(@"\cos^{-1} +x", @"\arccos \left( x\right) ", @"\arccos \left( x\right) ")]
    [InlineData(@"\cos^{-1} -x", @"\arccos \left( -x\right) ", @"\arccos \left( -x\right) ")]
    [InlineData(@"\tan^{-1} x\%", @"\arctan \left( \frac{x}{100}\right) ", @"\arctan \left( \frac{x}{100}\right) ")]
    [InlineData(@"\tan^{-1} x\%^2", @"\arctan \left( \left( \frac{x}{100}\right) ^2\right) ", @"\arctan \left( \left( \frac{x}{100}\right) ^2\right) ")]
    [InlineData(@"\cot^{-1} x\times y", @"\arccot \left( x\right) \cdot y", @"\arccot \left( x\right) \cdot y")]
    [InlineData(@"\cot^{-1} x/y", @"\frac{\arccot \left( x\right) }{y}", @"\frac{\arccot \left( x\right) }{y}")]
    [InlineData(@"\cos^{-1} \arccos^{-1} x", @"\arccos \left( \cos \left( x\right) \right) ", @"x")]
    [InlineData(@"\sin^1 x", @"\sin \left( x\right) ^1", @"\sin \left( x\right) ")]
    [InlineData(@"\sin^{+1} x", @"\sin \left( x\right) ^1", @"\sin \left( x\right) ")]
    [InlineData(@"\sin^{+-1} x", @"\sin \left( x\right) ^{-1}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin^{-+1} x", @"\sin \left( x\right) ^{-1}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin^{--1} x", @"\sin \left( x\right) ^{-\left( -1\right) \cdot 1}", @"\sin \left( x\right) ")]
    [InlineData(@"\sin^{-1^2} x", @"\sin \left( x\right) ^{-1^2}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin^{-1+3} xy+\cos^{-1+3} yx", @"\sin \left( xy\right) ^{-1+3}+\cos \left( yx\right) ^{-1+3}", @"1")]
    [InlineData(@"\log^{-a_2} x", @"\log \left( x\right) ^{-a_2}", @"\log \left( x\right) ^{-a_2}")]
    [InlineData(@"\ln^{3-1} x", @"\ln \left( x\right) ^{3-1}", @"\ln \left( x\right) ^2")]
    public void FunctionInverses(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"1+(2+3)", @"1+2+3", @"6")]
    [InlineData(@"1+((2+3))", @"1+2+3", @"6")]
    [InlineData(@"2\times(3+4)", @"2\left( 3+4\right) ", @"14")]
    [InlineData(@"(3+4)\times2", @"\left( 3+4\right) \cdot 2", @"14")]
    [InlineData(@"(5+6)^2", @"\left( 5+6\right) ^2", @"121")]
    [InlineData(@"(5+6)", @"5+6", @"11")]
    [InlineData(@"((5+6))", @"5+6", @"11")]
    [InlineData(@"(5+6)2", @"\left( 5+6\right) \cdot 2", @"22")]
    [InlineData(@"2(5+6)", @"2\left( 5+6\right) ", @"22")]
    [InlineData(@"2(5+6)2", @"2\left( 5+6\right) \cdot 2", @"44")]
    [InlineData(@"(5+6)x", @"\left( 5+6\right) \cdot x", @"11x")]
    [InlineData(@"x(5+6)", @"x\left( 5+6\right) ", @"11x")]
    [InlineData(@"x(5+6)x", @"x\left( 5+6\right) \cdot x", @"11x^2")]
    [InlineData(@"(5+6).2", @"\left( 5+6\right) \cdot \frac{1}{5}", @"\frac{11}{5}")]
    [InlineData(@".2(5+6)", @"\frac{1}{5}\left( 5+6\right) ", @"\frac{11}{5}")]
    [InlineData(@".2(5+6).2", @"\frac{1}{5}\left( 5+6\right) \cdot \frac{1}{5}", @"\frac{11}{25}")]
    [InlineData(@"(5+6)2.", @"\left( 5+6\right) \cdot 2", @"22")]
    [InlineData(@"2.(5+6)", @"2\left( 5+6\right) ", @"22")]
    [InlineData(@"2.(5+6)2.", @"2\left( 5+6\right) \cdot 2", @"44")]
    [InlineData(@"(5+6)(2)", @"\left( 5+6\right) \cdot 2", @"22")]
    [InlineData(@"(5+6)(1+1)", @"\left( 5+6\right) \left( 1+1\right) ", @"22")]
    [InlineData(@"(5+6)(-(-2))", @"\left( 5+6\right) \left( -1\right) \left( -1\right) \cdot 2", @"22")]
    [InlineData(@"(5+6)(--2)", @"\left( 5+6\right) \left( -1\right) \left( -1\right) \cdot 2", @"22")]
    [InlineData(@"+(1)", @"1", @"1")]
    [InlineData(@"+(1)\%", @"\frac{1}{100}", @"\frac{1}{100}")]
    [InlineData(@"+(-1)", @"-1", @"-1")]
    [InlineData(@"-(+1)", @"-1", @"-1")]
    [InlineData(@"-(-1)", @"-\left( -1\right) \cdot 1", @"1")]
    [InlineData(@"--(--1)", @"-\left( -1\right) \left( -1\right) \left( -1\right) \cdot 1", @"1")]
    [InlineData(@"(2+3)^{(4+5)}", @"\left( 2+3\right) ^{4+5}", @"1953125")]
    [InlineData(@"(2+3)^{((4)+5)}", @"\left( 2+3\right) ^{4+5}", @"1953125")]
    [InlineData(@"(1+i)\infty", @"\left( 1+\mathrm{i}\right) \cdot \infty ", @"\infty +\infty \mathrm{i}")]
    [InlineData(@"2\sin(x)", @"2\sin \left( x\right) ", @"2\sin \left( x\right) ")]
    [InlineData(@"(2)\sin(x)", @"2\sin \left( x\right) ", @"2\sin \left( x\right) ")]
    [InlineData(@"\sin(x+1)", @"\sin \left( x+1\right) ", @"\sin \left( 1+x\right) ")]
    [InlineData(@"\sin((x+1))", @"\sin \left( x+1\right) ", @"\sin \left( 1+x\right) ")]
    [InlineData(@"\sin(2(x+1))", @"\sin \left( 2\left( x+1\right) \right) ", @"\sin \left( 2\left( 1+x\right) \right) ")]
    [InlineData(@"\sin((x+1)+2)", @"\sin \left( x+1+2\right) ", @"\sin \left( 3+x\right) ")]
    [InlineData(@"\sin(x)2", @"\sin \left( x\right) \cdot 2", @"2\sin \left( x\right) ")]
    [InlineData(@"\sin(x)(x+1)", @"\sin \left( x\right) \left( x+1\right) ", @"\sin \left( x\right) \left( 1+x\right) ")]
    [InlineData(@"\sin(x)(x+1)(x)", @"\sin \left( x\right) \left( x+1\right) \cdot x", @"\sin \left( x\right) \left( 1+x\right) \cdot x")]
    [InlineData(@"\sin(x^2)", @"\sin \left( x^2\right) ", @"\sin \left( x^2\right) ")]
    [InlineData(@"\sin\ (x^2)", @"\sin \left( x^2\right) ", @"\sin \left( x^2\right) ")]
    [InlineData(@"\sin\; (x^2)", @"\sin \left( x^2\right) ", @"\sin \left( x^2\right) ")]
    [InlineData(@"\sin\ \; (x^2)", @"\sin \left( x^2\right) ", @"\sin \left( x^2\right) ")]
    [InlineData(@"\sin^3(x)", @"\sin \left( x\right) ^3", @"\sin \left( x\right) ^3")]
    [InlineData(@"\sin^3\ (x)", @"\sin \left( x\right) ^3", @"\sin \left( x\right) ^3")]
    [InlineData(@"\sin^3\; (x)", @"\sin \left( x\right) ^3", @"\sin \left( x\right) ^3")]
    [InlineData(@"\sin^3\ \; (x)", @"\sin \left( x\right) ^3", @"\sin \left( x\right) ^3")]
    [InlineData(@"\sin^{-1}(x)", @"\arcsin \left( x\right) ", @"\arcsin \left( x\right) ")]
    [InlineData(@"\sin^{-1}\ (x)", @"\arcsin \left( x\right) ", @"\arcsin \left( x\right) ")]
    [InlineData(@"\sin^{-1}\; (x)", @"\arcsin \left( x\right) ", @"\arcsin \left( x\right) ")]
    [InlineData(@"\sin^{-1}\ \; (x)", @"\arcsin \left( x\right) ", @"\arcsin \left( x\right) ")]
    [InlineData(@"\sin(x)^2", @"\sin \left( x\right) ^2", @"\sin \left( x\right) ^2")]
    [InlineData(@"\sin\ (x)^2", @"\sin \left( x\right) ^2", @"\sin \left( x\right) ^2")]
    [InlineData(@"\sin\; (x)^2", @"\sin \left( x\right) ^2", @"\sin \left( x\right) ^2")]
    [InlineData(@"\sin\ \; (x)^2", @"\sin \left( x\right) ^2", @"\sin \left( x\right) ^2")]
    [InlineData(@"\sin(x)^{-1}", @"\sin \left( x\right) ^{-1}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin\ (x)^{-1}", @"\sin \left( x\right) ^{-1}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin\; (x)^{-1}", @"\sin \left( x\right) ^{-1}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin\ \; (x)^{-1}", @"\sin \left( x\right) ^{-1}", @"\csc \left( x\right) ")]
    [InlineData(@"\sin^3(x)^{-1}", @"\sin \left( x\right) ^{3\left( -1\right) \cdot 1}", @"\frac{1}{\sin \left( x\right) ^3}")]
    [InlineData(@"\sin^3\ (x)^{-1}", @"\sin \left( x\right) ^{3\left( -1\right) \cdot 1}", @"\frac{1}{\sin \left( x\right) ^3}")]
    [InlineData(@"\sin^3\; (x)^{-1}", @"\sin \left( x\right) ^{3\left( -1\right) \cdot 1}", @"\frac{1}{\sin \left( x\right) ^3}")]
    [InlineData(@"\sin^3\ \; (x)^{-1}", @"\sin \left( x\right) ^{3\left( -1\right) \cdot 1}", @"\frac{1}{\sin \left( x\right) ^3}")]
    [InlineData(@"\sin^{-1}(x)^{-1}", @"\arcsin \left( x\right) ^{-1}", @"\frac{1}{\arcsin \left( x\right) }")]
    [InlineData(@"\sin^{-1}\ (x)^{-1}", @"\arcsin \left( x\right) ^{-1}", @"\frac{1}{\arcsin \left( x\right) }")]
    [InlineData(@"\sin^{-1}\; (x)^{-1}", @"\arcsin \left( x\right) ^{-1}", @"\frac{1}{\arcsin \left( x\right) }")]
    [InlineData(@"\sin^{-1}\ \; (x)^{-1}", @"\arcsin \left( x\right) ^{-1}", @"\frac{1}{\arcsin \left( x\right) }")]
    [InlineData(@"\sin^a(x)", @"\sin \left( x\right) ^a", @"\sin \left( x\right) ^a")]
    [InlineData(@"\sin^a(x)^2", @"\sin \left( x\right) ^{a\cdot 2}", @"\sin \left( x\right) ^{2a}")]
    [InlineData(@"\sin^a\ (x)^2", @"\sin \left( x\right) ^{a\cdot 2}", @"\sin \left( x\right) ^{2a}")]
    [InlineData(@"\sin^a\; (x)^2", @"\sin \left( x\right) ^{a\cdot 2}", @"\sin \left( x\right) ^{2a}")]
    [InlineData(@"\sin^a\ \; (x)^2", @"\sin \left( x\right) ^{a\cdot 2}", @"\sin \left( x\right) ^{2a}")]
    [InlineData(@"\sin(x)^2(x)", @"\sin \left( x\right) ^2\cdot x", @"\sin \left( x\right) ^2\cdot x")]
    [InlineData(@"\sin\ (x)^2(x)", @"\sin \left( x\right) ^2\cdot x", @"\sin \left( x\right) ^2\cdot x")]
    [InlineData(@"\sin\; (x)^2(x)", @"\sin \left( x\right) ^2\cdot x", @"\sin \left( x\right) ^2\cdot x")]
    [InlineData(@"\sin\ \; (x)^2(x)", @"\sin \left( x\right) ^2\cdot x", @"\sin \left( x\right) ^2\cdot x")]
    [InlineData(@"\sin^a(x)^2(x)", @"\sin \left( x\right) ^{a\cdot 2}\cdot x", @"\sin \left( x\right) ^{2a}\cdot x")]
    [InlineData(@"\sin^a\ (x)^2(x)", @"\sin \left( x\right) ^{a\cdot 2}\cdot x", @"\sin \left( x\right) ^{2a}\cdot x")]
    [InlineData(@"\sin^a\; (x)^2(x)", @"\sin \left( x\right) ^{a\cdot 2}\cdot x", @"\sin \left( x\right) ^{2a}\cdot x")]
    [InlineData(@"\sin^a\ \; (x)^2(x)", @"\sin \left( x\right) ^{a\cdot 2}\cdot x", @"\sin \left( x\right) ^{2a}\cdot x")]
    [InlineData(@"\sin (\frac\pi2)", @"\sin \left( \frac{\mathrm{\pi }}{2}\right) ", @"1")]
    [InlineData(@"\sin (\frac\pi2)+1", @"\sin \left( \frac{\mathrm{\pi }}{2}\right) +1", @"2")]
    public void Parentheses(string latex, string converted, string result) {
      Test(latex, converted, result);
      Test(latex.Replace('(', '[').Replace(')', ']'), converted, result);
    }
    [Theory]
    [InlineData(@"\begin{matrix}1\end{matrix}", @"\left[ \begin{matrix}1\end{matrix}\right] ", @"1")]
    [InlineData(@"\begin{matrix}1&2\\3&4\end{matrix}", @"\left[ \begin{matrix}1&2\\ 3&4\end{matrix}\right] ", @"\left[ \begin{matrix}1&2\\ 3&4\end{matrix}\right] ")]
    [InlineData(@"(\begin{matrix}1\end{matrix})^2", @"\left[ \begin{matrix}1\end{matrix}\right] ^2", @"1")]
    [InlineData(@"[\begin{matrix}1&2\end{matrix}]^2", @"\left[ \begin{matrix}1&2\end{matrix}\right] ^2", @"\left[ \begin{matrix}1&4\end{matrix}\right] ")]
    [InlineData(@"[\begin{matrix}3\\4\end{matrix}]^2", @"\left[ \begin{matrix}3\\ 4\end{matrix}\right] ^2", @"\left[ \begin{matrix}9\\ 16\end{matrix}\right] ")]
    [InlineData(@"[\begin{matrix}1&2\\3&4\end{matrix}]^2", @"\left[ \begin{matrix}1&2\\ 3&4\end{matrix}\right] ^2", @"\left[ \begin{matrix}7&10\\ 15&22\end{matrix}\right] ")]
    [InlineData(@"\begin{matrix}1&2\\3&4\end{matrix}+\begin{matrix}1&2\\3&5\end{matrix}", @"\left[ \begin{matrix}1&2\\ 3&4\end{matrix}\right] +\left[ \begin{matrix}1&2\\ 3&5\end{matrix}\right] ", @"\left[ \begin{matrix}2&4\\ 6&9\end{matrix}\right] ")]
    public void Matrices(string latex, string converted, string result) {
      Test(latex, converted, result);
      Test(latex.Replace("matrix", "pmatrix"), converted, result);
      Test(latex.Replace("matrix", "bmatrix"), converted, result);
    }
    [Theory]
    [InlineData(@"1,2", @"1,2")]
    [InlineData(@"1,2,3", @"1,2,3")]
    [InlineData(@"a,b,c,d", @"a,b,c,d")]
    [InlineData(@"\sqrt2,\sqrt[3]2,\frac34", @"\sqrt{2},2^{\frac{1}{3}},\frac{3}{4}")]
    [InlineData(@"\sin a,\cos b^2,\tan c_3,\cot de,\sec 12f,\csc g+h",
      @"\sin \left( a\right) ,\cos \left( b^2\right) ,\tan \left( c_3\right) ,\cot \left( d\mathrm{e}\right) ,\sec \left( 12f\right) ,\csc \left( g\right) +h")]
    public void Comma(string latex, string converted) => Test(latex, converted, null);
    [Theory]
    [InlineData(@"\emptyset", @"\emptyset ")]
    [InlineData(@"\mathbb Z", @"\mathbb{Z}")]
    [InlineData(@"\mathbb Q", @"\mathbb{Q}")]
    [InlineData(@"\mathbb R", @"\mathbb{R}")]
    [InlineData(@"\mathbb C", @"\mathbb{C}")]
    [InlineData(@"\{\}", @"\emptyset ")]
    [InlineData(@"\left\{\right\}", @"\emptyset ")]
    [InlineData(@"\left\{1\right\}", @"\left\{ 1\right\} ")]
    [InlineData(@"\{1\}", @"\left\{ 1\right\} ")]
    [InlineData(@"\{1,2\}", @"\left\{ 1,2\right\} ")]
    [InlineData(@"\{x,y\}", @"\left\{ x,y\right\} ")]
    [InlineData(@"\{\sqrt[3]2,\frac34,\sin^2x\}", @"\left\{ 2^{\frac{1}{3}},\frac{3}{4},\sin \left( x\right) ^2\right\} ")]
    [InlineData(@"\{\{\}\}", @"\left\{ \emptyset \right\} ")]
    [InlineData(@"\{\left\{\right\}\}", @"\left\{ \emptyset \right\} ")]
    public void Sets(string latex, string converted) => Test(latex, converted, null);
    [Theory]
    [InlineData(@"\emptyset\cup\{2\}", @"\emptyset \cup \left\{ 2\right\} ", @"\left\{ 2\right\} ")]
    [InlineData(@"\{1\}\cup\{2\}", @"\left\{ 1\right\} \cup \left\{ 2\right\} ", @"\left\{ 1,2\right\} ")]
    [InlineData(@"\{3,4\}\cap\emptyset", @"\left\{ 3,4\right\} \cap \emptyset ", @"\emptyset ")]
    [InlineData(@"\{3,4\}\cap\{4,5\}", @"\left\{ 3,4\right\} \cap \left\{ 4,5\right\} ", @"\left\{ 4\right\} ")]
    [InlineData(@"\{2,3,4\}\setminus\{4\}", @"\left\{ 2,3,4\right\} \setminus \left\{ 4\right\} ", @"\left\{ 2,3\right\} ")]
    [InlineData(@"\emptyset^\complement", @"\mathbb{C}\setminus \emptyset ", @"\mathbb{C}")]
    [InlineData(@"\{3\}^\complement", @"\mathbb{C}\setminus \left\{ 3\right\} ", @"\mathbb{C}\setminus \left\{ 3\right\} ")]
    [InlineData(@"\mathbb R+1", @"\mathbb{R}+1", @"\mathbb{R}+1")]
    [InlineData(@"\sin^\complement x", @"\mathbb{C}\setminus \sin \left( x\right) ", @"\mathbb{C}\setminus \sin \left( x\right) ")]
    [InlineData(@"1^\complement", @"\mathbb{C}\setminus 1", @"\mathbb{C}\setminus 1")]
    public void SetOperations(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"(1,2)", @"\left( 1,2\right) ", @"\left( 1,2\right) ")]
    [InlineData(@"[1,2)", @"\left[ 1,2\right) ", @"\left[ 1,2\right) ")]
    [InlineData(@"(1,2]", @"\left( 1,2\right] ", @"\left( 1,2\right] ")]
    [InlineData(@"[1,2]", @"\left[ 1,2\right] ", @"\left[ 1,2\right] ")]
    [InlineData(@"(2,1)", @"\left( 2,1\right) ", @"\left( 2,1\right) ")]
    [InlineData(@"[2,1)", @"\left[ 2,1\right) ", @"\left[ 2,1\right) ")]
    [InlineData(@"(2,1]", @"\left( 2,1\right] ", @"\left( 2,1\right] ")]
    [InlineData(@"[2,1]", @"\left[ 2,1\right] ", @"\left[ 2,1\right] ")]
    [InlineData(@"[1,2]\setminus\{1\}", @"\left[ 1,2\right] \setminus \left\{ 1\right\} ", @"\left[ 1,2\right] \setminus \left\{ 1\right\} ")]
    [InlineData(@"[1,2]\setminus\{2\}", @"\left[ 1,2\right] \setminus \left\{ 2\right\} ", @"\left[ 1,2\right] \setminus \left\{ 2\right\} ")]
    [InlineData(@"[1,2]\cup(2,3)", @"\left[ 1,2\right] \cup \left( 2,3\right) ", @"\left[ 1,3\right) ")]
    [InlineData(@"[1,2]\cap[1.5,1.6]", @"\left[ 1,2\right] \cap \left[ \frac{3}{2},\frac{8}{5}\right] ", @"\left[ \frac{3}{2},\frac{8}{5}\right] ")]
    [InlineData(@"[1.5,1.5]", @"\left\{ \frac{3}{2}\right\} ", @"\left\{ \frac{3}{2}\right\} ")]
    [InlineData(@"(1.5,1.5]", @"\emptyset ", @"\emptyset ")]
    [InlineData(@"[1.5,1.5)", @"\emptyset ", @"\emptyset ")]
    [InlineData(@"(1.5,1.5)", @"\emptyset ", @"\emptyset ")]
    [InlineData(@"[xy,xy]", @"\left\{ xy\right\} ", @"\left\{ xy\right\} ")]
    [InlineData(@"(xy,xy]", @"\emptyset ", @"\emptyset ")]
    [InlineData(@"[xy,xy)", @"\emptyset ", @"\emptyset ")]
    [InlineData(@"(xy,xy)", @"\emptyset ", @"\emptyset ")]
    [InlineData(@"\frac{[7, 8]}{9}", @"\frac{\left[ 7,8\right] }{9}", @"\frac{\left[ 7,8\right] }{9}")]
    [InlineData(@"+(3,4]", @"\left( 3,4\right] ", @"\left( 3,4\right] ")]
    public void Intervals(string latex, string converted, string result) {
      Test(latex, converted, result);
      Test(latex.Replace(",", ";"), converted, result);
    }
    [Theory]
    [InlineData(@"\>\:\pi", @"\mathrm{\pi }", @"\mathrm{\pi }")]
    [InlineData(@"3\quad 2", @"3\cdot 2", "6")]
    [InlineData(@"a\textstyle b\displaystyle", @"ab", @"ab")]
    [InlineData(@"a^6+2a^6 % should be 3a^6", @"a^6+2a^6", @"3a^6")]
    [InlineData(@"4+\ \mkern1.5mu3", @"4+3", "7")]
    public void SkipInvisible(string latex, string converted, string output) => Test(latex, converted, output);
    [Theory]
    [InlineData(@"", "There is nothing to evaluate")]
    [InlineData(@"\ ", "There is nothing to evaluate")]
    [InlineData(@"\;", "There is nothing to evaluate")]
    [InlineData(@"\quad", "There is nothing to evaluate")]
    [InlineData(@"+", "Missing right operand for +")]
    [InlineData(@"-", "Missing right operand for \u2212")]
    [InlineData(@"\times", "Unsupported Unary Operator ×")]
    [InlineData(@"\div", "Unsupported Unary Operator ÷")]
    [InlineData(@"\%", "Missing left operand for %")]
    [InlineData(@"\degree", "Missing left operand for °")]
    [InlineData(@"\dagger", "Unsupported Unary Operator †")]
    [InlineData(@"\times x", "Unsupported Unary Operator ×")]
    [InlineData(@"\div x", "Unsupported Unary Operator ÷")]
    [InlineData(@"\% x", "Missing left operand for %")]
    [InlineData(@"\degree x", "Missing left operand for °")]
    [InlineData(@"x+", "Missing right operand for +")]
    [InlineData(@"x-", "Missing right operand for \u2212")]
    [InlineData(@"x\times", "Missing right operand for ×")]
    [InlineData(@"x\div", "Missing right operand for ÷")]
    [InlineData(@"x\dagger", "Unsupported Binary Operator †")]
    [InlineData(@"+^2", "Superscripts are unsupported for Unary Operator +")]
    [InlineData(@"+_2", "Missing right operand for +")]
    [InlineData(@"+^21", "Superscripts are unsupported for Unary Operator +")]
    [InlineData(@"+_21", "Subscripts are unsupported for Unary Operator +")]
    [InlineData(@"1+^21", "Superscripts are unsupported for Binary Operator +")]
    [InlineData(@"1+_21", "Subscripts are unsupported for Binary Operator +")]
    [InlineData(@"-_31", "Subscripts are unsupported for Unary Operator −")]
    [InlineData(@"1\times_41", "Subscripts are unsupported for Binary Operator ×")]
    [InlineData(@"\div_51", "Unsupported Unary Operator ÷")]
    [InlineData(@"1\%_6", "Subscripts are unsupported for Ordinary %")]
    [InlineData(@"1\degree_7", "Subscripts are unsupported for Ordinary °")]
    [InlineData(@"\dagger_8", "Unsupported Unary Operator †")]
    [InlineData(@".", "Invalid number: .")]
    [InlineData(@"..", "Invalid number: ..")]
    [InlineData(@"1..", "Invalid number: 1..")]
    [InlineData(@"..1", "Invalid number: ..1")]
    [InlineData(@"a_+", "Unsupported Unary Operator + in subscript")]
    [InlineData(@"a_|", "Unsupported Ordinary | in subscript")]
    [InlineData(@"a_{1+1}", "Unsupported Binary Operator + in subscript")]
    [InlineData(@"a_{2^3}", "Unsupported exponentiation in subscript")]
    [InlineData(@"a_{a2^3}", "Unsupported exponentiation in subscript")]
    [InlineData(@"a_{a^32}", "Unsupported exponentiation in subscript")]
    [InlineData(@"a_{2_3}", "Unsupported subscript in subscript")]
    [InlineData(@"a_{a2_3}", "Unsupported subscript in subscript")]
    [InlineData(@"a_{a_32}", "Unsupported subscript in subscript")]
    [InlineData(@"a_{1,2}", "Unsupported Punctuation , in subscript")]
    [InlineData(@"\square", "Placeholders should be filled")]
    [InlineData(@"x^\square", "Placeholders should be filled")]
    [InlineData(@"\square^x", "Placeholders should be filled")]
    [InlineData(@"a_\square", "Placeholders should be filled")]
    [InlineData(@"\square_a", "Placeholders should be filled")]
    [InlineData(@"(", "Missing )")]
    [InlineData(@"(_21)", "Subscripts are unsupported for Open (")]
    [InlineData(@"(x", "Missing )")]
    [InlineData(@"((x)", "Missing )")]
    [InlineData(@"(+", "Missing right operand for +")]
    [InlineData(@")", "Missing (")]
    [InlineData(@"(1)_2", "Subscripts are unsupported for Close )")]
    [InlineData(@"x)", "Missing (")]
    [InlineData(@"(x))", "Missing (")]
    [InlineData(@"+)", "Missing right operand for +")]
    [InlineData(@"\left(\right)", "Missing math inside ( )")]
    [InlineData(@"\left(1+\right)", "Missing right operand for +")]
    [InlineData(@"\left(2,3\right)^\square", "Placeholders should be filled")]
    [InlineData(@"(2,3)^\square", "Placeholders should be filled")]
    [InlineData(@"[", "Missing ]")]
    [InlineData(@"[_21)", "Unrecognized bracket pair [ )")]
    [InlineData(@"[x", "Missing ]")]
    [InlineData(@"[x)", "Unrecognized bracket pair [ )")]
    [InlineData(@"[[x)", "Unrecognized bracket pair [ )")]
    [InlineData(@"[+", "Missing right operand for +")]
    [InlineData(@"[x))", "Unrecognized bracket pair [ )")]
    [InlineData(@"\left[\right)", "Unrecognized bracket pair [ )")]
    [InlineData(@"\left[1+\right)", "Missing right operand for +")]
    [InlineData(@"\left[2,3\right)^\square", "Placeholders should be filled")]
    [InlineData(@"[2,3)^\square", "Placeholders should be filled")]
    [InlineData(@"((x]", "Unrecognized bracket pair ( ]")]
    [InlineData(@"(x]", "Unrecognized bracket pair ( ]")]
    [InlineData(@"]", "Missing [")]
    [InlineData(@"]_2", "Subscripts are unsupported for Close ]")]
    [InlineData(@"x]", "Missing [")]
    [InlineData(@"(x]]", "Unrecognized bracket pair ( ]")]
    [InlineData(@"+]", "Missing right operand for +")]
    [InlineData(@"\left(\right]", "Unrecognized bracket pair ( ]")]
    [InlineData(@"\left(1+\right]", "Missing right operand for +")]
    [InlineData(@"\left(2,3\right]^\square", "Placeholders should be filled")]
    [InlineData(@"(2,3]^\square", "Placeholders should be filled")]
    [InlineData(@"[]", "Missing math inside [ ]")]
    [InlineData(@"[[x]", "Missing ]")]
    [InlineData(@"[x]]", "Missing [")]
    [InlineData(@"[_\square x]", "Subscripts are unsupported for Open [")]
    [InlineData(@"[x]_\square", "Subscripts are unsupported for Close ]")]
    [InlineData(@"\left[\right]", "Missing math inside [ ]")]
    [InlineData(@"\left[1+\right]", "Missing right operand for +")]
    [InlineData(@"\left[2,3\right]^\square", "Placeholders should be filled")]
    [InlineData(@"[2,3]^\square", "Placeholders should be filled")]
    [InlineData(@"\{", "Missing }")]
    [InlineData(@"\{_2\}", "Subscripts are unsupported for Open {")]
    [InlineData(@"\{x", "Missing }")]
    [InlineData(@"\{\{x\}", "Missing }")]
    [InlineData(@"\{+", "Missing right operand for +")]
    [InlineData(@"\}", "Missing {")]
    [InlineData(@"\}_2", "Subscripts are unsupported for Close }")]
    [InlineData(@"x\}", "Missing {")]
    [InlineData(@"\{x\}\}", "Missing {")]
    [InlineData(@"+\}", "Missing right operand for +")]
    [InlineData(@"\left\{1+\right\}", "Missing right operand for +")]
    [InlineData(@"\left\{\{\right\}\}", @"Missing }")]
    [InlineData(@"\{2,3\}^\square", "Placeholders should be filled")]
    [InlineData(@"(^2)", "Superscripts are unsupported for Open Bracket (")]
    [InlineData(@"[^2]", "Superscripts are unsupported for Open Bracket [")]
    [InlineData(@"\{^2\}", "Superscripts are unsupported for Open Bracket {")]
    [InlineData(@"\left\{2,3\right\}^\square", "Placeholders should be filled")]
    [InlineData(@"\frac{}{x}", "Missing numerator")]
    [InlineData(@"\frac{x}{}", "Missing denominator")]
    [InlineData(@"\sqrt{}", "Missing radicand")]
    [InlineData(@"\sin", "Missing argument for sin")]
    [InlineData(@"\cos-", "Missing right operand for \u2212")]
    [InlineData(@"\tan\times", "Unsupported Unary Operator ×")]
    [InlineData(@"\cot^(-1)", "Missing )")]
    [InlineData(@"\sec\csc", "Missing argument for csc")]
    [InlineData(@"\arcsin_2x", "Subscripts are unsupported for Large Operator arcsin")]
    [InlineData(@"\operatorname{dab}", "Unsupported Large Operator dab")]
    [InlineData(@"\begin{matrix}\end{matrix}", "Missing matrix element")]
    [InlineData(@"\begin{matrix}2&3\end{matrix}_2", "Subscripts are unsupported for Ordinary")]
    [InlineData(@"\begin{matrix}2&3\end{matrix}^2", "Superscripts are unsupported for Ordinary")]
    [InlineData(@"\begin{pmatrix}2&+\end{pmatrix}", "Missing right operand for +")]
    [InlineData(@"\begin{pmatrix}2&3\end{pmatrix}_2", "Subscripts are unsupported for Inner ")]
    [InlineData(@"\begin{Vmatrix}\end{Vmatrix}", "Missing matrix element")]
    [InlineData(@"\begin{Vmatrix}2&3\end{Vmatrix}", "Unrecognized bracket pair ‖ ‖")]
    [InlineData(@"\begin{eqnarray}&&\end{eqnarray}", "Unsupported table environment eqnarray")]
    [InlineData(@",", "Missing left operand for comma")]
    [InlineData(@"1,_22", "Subscripts are unsupported for Punctuation ,")]
    [InlineData(@"1,", "Missing right operand for comma")]
    [InlineData(@",1", "Missing left operand for comma")]
    [InlineData(@",1,2", "Missing left operand for comma")]
    [InlineData(@"1,,2", "Missing left operand for comma")]
    [InlineData(@"1,2,", "Missing right operand for comma")]
    [InlineData(@",,1,2", "Missing left operand for comma")]
    [InlineData(@"1,,2,", "Missing left operand for comma")]
    [InlineData(@"1,2,,", "Missing left operand for comma")]
    [InlineData(@"\arcsin(1,2)", "Comma cannot be argument for arcsin")]
    [InlineData(@"[5,6)\times", "Missing right operand for ×")]
    [InlineData(@"\sqrt[{[)}]{}", "Unrecognized bracket pair [ )")]
    [InlineData(@"\sqrt[{[a,b]}]{}", "Missing radicand")]
    [InlineData(@"\cap", "Unsupported Unary Operator ∩")]
    [InlineData(@"\cap1", "Unsupported Unary Operator ∩")]
    [InlineData(@"1\cap", "Missing right operand for ∩")]
    [InlineData(@"\cup", "Unsupported Unary Operator ∪")]
    [InlineData(@"\cup1", "Unsupported Unary Operator ∪")]
    [InlineData(@"1\cup", "Missing right operand for ∪")]
    [InlineData(@"\setminus", "Unsupported Unary Operator ∖")]
    [InlineData(@"\setminus1", "Unsupported Unary Operator ∖")]
    [InlineData(@"1\setminus", "Missing right operand for ∖")]
    [InlineData(@"^\complement", "Superscripts are unsupported for Ordinary")]
    [InlineData(@"_\complement", "Subscripts are unsupported for Ordinary")]
    [InlineData(@"1_\complement", "Subscripts are unsupported for Number 1")]
    [InlineData(@"x_\complement", "Unsupported Ordinary ∁ in subscript")]
    [InlineData(@"\sin_\complement x", "Subscripts are unsupported for Large Operator sin")]
    [InlineData(@",\cap", "Missing left operand for comma")]
    [InlineData(@";\cap", "Missing left operand for comma")]
    [InlineData(@"1,\cap", "Unsupported Unary Operator ∩")]
    [InlineData(@"1;\cap", "Unsupported Unary Operator ∩")]
    [InlineData(@"\cap,", "Unsupported Unary Operator ∩")]
    [InlineData(@"\cap;", "Unsupported Unary Operator ∩")]
    [InlineData(@"\left|1,2\right|", "Comma cannot be abs argument")]
    [InlineData(@"1^+", "+ alone in superscript but not in limit subscript context")]
    [InlineData(@"1^-", "\u2212 alone in superscript but not in limit subscript context")]
    [InlineData(@"\lim", "Missing limit variable in subscript")]
    [InlineData(@"\lim_x", "Missing → in limit subscript")]
    [InlineData(@"\lim_{xy}", "Missing → in limit subscript")]
    [InlineData(@"\lim_{xy^+}", "Missing → in limit subscript")]
    [InlineData(@"\lim_{xy^-}", "Missing → in limit subscript")]
    [InlineData(@"\lim_{\to}", "Missing limit variable in subscript")]
    [InlineData(@"\lim_{\to2}", "Missing limit variable in subscript")]
    [InlineData(@"\lim_{x\to}", "Missing limit target in subscript")]
    [InlineData(@"\lim_{xy\to}", "Missing limit target in subscript")]
    [InlineData(@"\lim_{xy\to^+}", "Missing limit target in subscript")]
    [InlineData(@"\lim_{xy\to^-}", "Missing limit target in subscript")]
    [InlineData(@"\lim_{x\to2^+2}", "Limit direction indicator + not placed at the end")]
    [InlineData(@"\lim_{xy\to2^+2}", "Limit direction indicator + not placed at the end")]
    [InlineData(@"\lim_{xy\to2^-2}", "Limit direction indicator \u2212 not placed at the end")]
    [InlineData(@"\lim_{xy\to(2^+)}", "+ alone in superscript but not in limit subscript context")]
    [InlineData(@"\lim_{xy\to(2^-)}", "\u2212 alone in superscript but not in limit subscript context")]
    [InlineData(@"\lim_{xy\to\left(2^+\right)}", "+ alone in superscript but not in limit subscript context")]
    [InlineData(@"\lim_{xy\to\left(2^-\right)}", "\u2212 alone in superscript but not in limit subscript context")]
    [InlineData(@"\lim_{x,y}", "Comma cannot be limit variable in subscript")]
    [InlineData(@"\lim_{x\to2}", "Missing right operand for lim")]
    [InlineData(@"(\lim_{x\to2})x", "Missing right operand for lim")]
    [InlineData(@"\lim_{x\to2}\cdot 1", "Unsupported Unary Operator ·")]
    [InlineData(@"\lim_{x\to2}^6x", "Superscripts are unsupported for Large Operator lim")]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}}", "Missing derivative variable")]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}x}", "Missing right operand for derivative operator")]
    [InlineData(@"\frac{\mathrm{d}^{1.5}}{\mathrm{d}x^{1.5}}", "Derivative order must be an integer, got 1.5")]
    [InlineData(@"\frac{\mathrm{d}^a}{\mathrm{d}x^a}", "Derivative order must be an integer")]
    [InlineData(@"\frac{\mathrm{d}^2}{\mathrm{d}}", "Missing derivative variable")]
    [InlineData(@"\frac{\mathrm{d}^2}{\mathrm{d}^2}", "The d in derivative denominator cannot have an exponent. Did you mean to write it at the end of the denominator?")]
    [InlineData(@"\frac{\mathrm{d}^2x}{\mathrm{d}^2}", "The d in derivative denominator cannot have an exponent. Did you mean to write it at the end of the denominator?")]
    [InlineData(@"\frac{\mathrm{d}^3}{\mathrm{d}x^2}", "Derivative order mismatch: 3 in numerator but 2 is in denominator")]
    [InlineData(@"\frac{\mathrm{d}^0}{\mathrm{d}x^1}", "Derivative order mismatch: 0 in numerator but 1 is in denominator")]
    [InlineData(@"\frac{\mathrm{d}^{-1}}{\mathrm{d}x^1}", "Derivative order mismatch: -1 in numerator but 1 is in denominator")]
    [InlineData(@"\frac{\mathrm{d}^{-3}}{\mathrm{d}x^{-2}}", "Derivative order mismatch: -3 in numerator but -2 is in denominator")]
    [InlineData(@"\frac{\mathrm{d}^{-3}}{\mathrm{d}x^{-2.5}}", "Derivative order must be an integer, got -2.5")]
    [InlineData(@"\frac{\mathrm{d}^2}{\mathrm{d}(x^2)}", "Derivative order mismatch: 2 in numerator requires 2 in denominator")]
    [InlineData(@"\frac{\mathrm{d}^2\cdot 1}{\mathrm{d}x^2}", "Unsupported Unary Operator ·")]
    [InlineData(@"\left(\frac{\mathrm{d}^2}{\mathrm{d}x^2}\right)x", "Missing right operand for derivative operator")]
    [InlineData(@"\int", "Missing integral variable. Did you forget to prepend it with upright d?")]
    [InlineData(@"\int_0", "Integrals with only the lower limit are not supported")]
    [InlineData(@"\int^0", "Integrals with only the upper limit are not supported")]
    [InlineData(@"\int0", "Missing integral variable. Did you forget to prepend it with upright d?")]
    [InlineData(@"\int_0^0", "Missing integral variable. Did you forget to prepend it with upright d?")]
    [InlineData(@"\mathrm{d}", "d alone but not in integral body context")]
    [InlineData(@"\int(\mathrm{d}", "d alone but not in integral body context")]
    [InlineData(@"\int1,2\mathrm{d}x", "d alone but not in integral body context")]
    [InlineData(@"\mathrm{for}", "Unsupported Unary Operator for")]
    [InlineData(@"1\mathrm{for}", "Missing right operand for for")]
    [InlineData(@"\mathrm{for}2", "Unsupported Unary Operator for")]
    [InlineData(@"\mathrm{for},", "Unsupported Unary Operator for")]
    [InlineData(@"1\mathrm{for},", "Missing right operand for for")]
    [InlineData(@"1\mathrm{for}^23,", "for operator cannot have a superscript")]
    [InlineData(@"1\mathrm{for}_23,", "for operator cannot have a subscript")]
    [InlineData(@"\begin{cases}1,2\end{cases}", "Comma cannot be case expression")]
    [InlineData(@"\begin{cases}1&3,4\end{cases}", "Comma cannot be case predicate")]
    [InlineData(@"\begin{cases}1,2&3,4\end{cases}", "Comma cannot be case expression")]
    [InlineData(@"\begin{cases}&3,4\end{cases}", "Missing case expression")]
    [InlineData(@"\begin{cases}1&\end{cases}", "Missing case predicate")]
    [InlineData(@"\begin{cases}1&\mathrm{for}^23\end{cases}", "for operator cannot have a superscript")]
    [InlineData(@"\begin{cases}1&\mathrm{for}_23\end{cases}", "for operator cannot have a subscript")]
    [InlineData(@"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{otherwise}&ERROR\\ \textstyle x-1&\textstyle \mathrm{otherwise}\end{array}\right. ", "The cases environment must have 1 to 2 columns per row")]
    public void Error(string badLaTeX, string error) =>
      Evaluation.Evaluate(ParseLaTeX(badLaTeX))
      .Match(entity => throw new Xunit.Sdk.XunitException(entity.Latexise()), e => Assert.Equal(error, e));
    // https://github.com/ForNeVeR/wpf-math/issues/42
    [Theory]
    [InlineData("1 + 1 - 1", @"1+1-1")]
    [InlineData("3 / 2", @"\frac{3}{2}")]
    [InlineData("2 * 3 / 5", @"\frac{2\cdot 3}{5}")]
    [InlineData("sin(x+pi)", @"\sin \left( x+\mathrm{\pi }\right) ")]
    [InlineData("sin(aaa)", @"\sin \left( \mathrm{aaa}\right) ")]
    [InlineData("sin(aaa aaa aa)", @"\sin \left( \mathrm{aaa}\cdot \mathrm{aaa}\cdot \mathrm{aa}\right) ")]
    [InlineData("log(3,alpha)", @"\log _3\left( \alpha \right) ")]
    [InlineData("a_2k", @"a_{\mathrm{2k}}")]
    [InlineData("2e9", @"2000000000")]
    [InlineData("-3e4^x", @"-30000^x")]
    [InlineData("(-3e4)^x", @"\left( -30000\right) ^x")]
    [InlineData("i+2i", @"\mathrm{i}+2\mathrm{i}")]
    public void SimpleArithmeticSyntax(string simpleSyntax, string latex) =>
      Assert.Equal(latex, LaTeXParser.MathListToLaTeX(Evaluation.Visualize((Entity)simpleSyntax)).ToString());
    [Theory]
    [InlineData(@"\top", @"\top ", @"\top ")]
    [InlineData(@"\bot", @"\bot ", @"\bot ")]
    [InlineData(@"\neg\top", @"\neg \top ", @"\bot ")]
    [InlineData(@"\neg\bot", @"\neg \bot ", @"\top ")]
    [InlineData(@"\top\land\top", @"\top \wedge \top ", @"\top ")]
    [InlineData(@"\top\land\bot", @"\top \wedge \bot ", @"\bot ")]
    [InlineData(@"\bot\land\top", @"\bot \wedge \top ", @"\bot ")]
    [InlineData(@"\bot\land\bot", @"\bot \wedge \bot ", @"\bot ")]
    [InlineData(@"\top\lor\top", @"\top \vee \top ", @"\top ")]
    [InlineData(@"\top\lor\bot", @"\top \vee \bot ", @"\top ")]
    [InlineData(@"\bot\lor\top", @"\bot \vee \top ", @"\top ")]
    [InlineData(@"\bot\lor\bot", @"\bot \vee \bot ", @"\bot ")]
    [InlineData(@"\top\veebar\top", @"\top \veebar \top ", @"\bot ")]
    [InlineData(@"\top\veebar\bot", @"\top \veebar \bot ", @"\top ")]
    [InlineData(@"\bot\veebar\top", @"\bot \veebar \top ", @"\top ")]
    [InlineData(@"\bot\veebar\bot", @"\bot \veebar \bot ", @"\bot ")]
    [InlineData(@"\top\barwedge\top", @"\neg \left( \top \wedge \top \right) ", @"\bot ")]
    [InlineData(@"\top\barwedge\bot", @"\neg \left( \top \wedge \bot \right) ", @"\top ")]
    [InlineData(@"\bot\barwedge\top", @"\neg \left( \bot \wedge \top \right) ", @"\top ")]
    [InlineData(@"\bot\barwedge\bot", @"\neg \left( \bot \wedge \bot \right) ", @"\top ")]
    [InlineData(@"\top\rightarrow\top", @"\top \rightarrow \top ", @"\top ")]
    [InlineData(@"\top\rightarrow\bot", @"\top \rightarrow \bot ", @"\bot ")]
    [InlineData(@"\bot\rightarrow\top", @"\bot \rightarrow \top ", @"\top ")]
    [InlineData(@"\bot\rightarrow\bot", @"\bot \rightarrow \bot ", @"\top ")]
    [InlineData(@"\top\nrightarrow\top", @"\neg \left( \top \rightarrow \top \right) ", @"\bot ")]
    [InlineData(@"\top\nrightarrow\bot", @"\neg \left( \top \rightarrow \bot \right) ", @"\top ")]
    [InlineData(@"\bot\nrightarrow\top", @"\neg \left( \bot \rightarrow \top \right) ", @"\bot ")]
    [InlineData(@"\bot\nrightarrow\bot", @"\neg \left( \bot \rightarrow \bot \right) ", @"\bot ")]
    [InlineData(@"\top\leftarrow\top", @"\top \rightarrow \top ", @"\top ")]
    [InlineData(@"\bot\leftarrow\top", @"\top \rightarrow \bot ", @"\bot ")]
    [InlineData(@"\top\leftarrow\bot", @"\bot \rightarrow \top ", @"\top ")]
    [InlineData(@"\bot\leftarrow\bot", @"\bot \rightarrow \bot ", @"\top ")]
    [InlineData(@"\top\nleftarrow\top", @"\neg \left( \top \rightarrow \top \right) ", @"\bot ")]
    [InlineData(@"\bot\nleftarrow\top", @"\neg \left( \top \rightarrow \bot \right) ", @"\top ")]
    [InlineData(@"\top\nleftarrow\bot", @"\neg \left( \bot \rightarrow \top \right) ", @"\bot ")]
    [InlineData(@"\bot\nleftarrow\bot", @"\neg \left( \bot \rightarrow \bot \right) ", @"\bot ")]
    [InlineData(@"\top\leftrightarrow\top", @"\neg \left( \top \veebar \top \right) ", @"\top ")]
    [InlineData(@"\bot\leftrightarrow\top", @"\neg \left( \bot \veebar \top \right) ", @"\bot ")]
    [InlineData(@"\top\leftrightarrow\bot", @"\neg \left( \top \veebar \bot \right) ", @"\bot ")]
    [InlineData(@"\bot\leftrightarrow\bot", @"\neg \left( \bot \veebar \bot \right) ", @"\top ")]
    [InlineData(@"\top\nleftrightarrow\top", @"\top \veebar \top ", @"\bot ")]
    [InlineData(@"\bot\nleftrightarrow\top", @"\bot \veebar \top ", @"\top ")]
    [InlineData(@"\top\nleftrightarrow\bot", @"\top \veebar \bot ", @"\top ")]
    [InlineData(@"\bot\nleftrightarrow\bot", @"\bot \veebar \bot ", @"\bot ")]
    [InlineData(@"x=x", @"x=x", @"\top ")]
    [InlineData(@"x\le x", @"x\leq x", @"\top ")]
    [InlineData(@"x\leq x", @"x\leq x", @"\top ")]
    [InlineData(@"x\leqslant x", @"x\leq x", @"\top ")]
    [InlineData(@"x\neq y", @"x\neq y", @"x\neq y")] // Cannot simplify without knowing x and y
    [InlineData(@"1<2", @"1<2", @"\top ")]
    [InlineData(@"2<1", @"2<1", @"\bot ")]
    [InlineData(@"1\le1", @"1\leq 1", @"\top ")]
    [InlineData(@"2>1", @"2>1", @"\top ")]
    [InlineData(@"1>2", @"1>2", @"\bot ")]
    [InlineData(@"1\ge1", @"1\geq 1", @"\top ")]
    [InlineData(@"1\geq1", @"1\geq 1", @"\top ")]
    [InlineData(@"1\geqslant1", @"1\geq 1", @"\top ")]
    [InlineData(@"x\in\{x,y\}", @"x\in \left\{ x,y\right\} ", @"\top ")]
    [InlineData(@"z\notin\{x,y\}", @"\neg z\in \left\{ x,y\right\} ", @"\neg z\in \left\{ x,y\right\} ")] // Cannot determine this without knowing x, y, and z
    [InlineData(@"\{x,y\}\ni x", @"x\in \left\{ x,y\right\} ", @"\top ")]
    public void LogicalAndRelationalOperators(string latex, string converted, string result) => Test(latex, converted, result);

    [Theory]
    // Test that ∧ binds tighter than ∨
    [InlineData(@"\bot\land\bot\lor\top", @"\bot \wedge \bot \vee \top ", @"\top ")]
    [InlineData(@"\top\lor\bot\land\bot", @"\top \vee \bot \wedge \bot ", @"\top ")]
    // Test that ∧ binds tighter than ⊻
    [InlineData(@"\top\veebar\bot\land\top", @"\top \veebar \bot \wedge \top ", @"\top ")]
    [InlineData(@"\top\land\bot\veebar\top", @"\top \wedge \bot \veebar \top ", @"\top ")]
    // Test that ⊻ binds tighter than ∨
    [InlineData(@"\top\veebar \bot\lor \top", @"\top \veebar \bot \vee \top ", @"\top ")]
    [InlineData(@"\top\vee \bot\veebar \top", @"\top \vee \bot \veebar \top ", @"\top ")]
    // Test that → is right associative and lowest precedence
    [InlineData(@"a\to b\lor c", @"a\rightarrow b\vee c", @"a\rightarrow b\vee c")]
    [InlineData(@"a\lor b\to c", @"a\vee b\rightarrow c", @"a\vee b\rightarrow c")]
    [InlineData(@"a\to b\to c", @"a\rightarrow b\rightarrow c", @"a\rightarrow b\rightarrow c")]
    [InlineData(@"a\to (b\to c)", @"a\rightarrow b\rightarrow c", @"a\rightarrow b\rightarrow c")]
    [InlineData(@"(a\to b)\to c", @"\left( a\rightarrow b\right) \rightarrow c", @"\left( a\rightarrow b\right) \rightarrow c")]
    // Complex expression
    [InlineData(@"a\to b\land c\lor d", @"a\rightarrow b\wedge c\vee d", @"a\rightarrow b\wedge c\vee d")]
    // Test ¬ has highest precedence
    [InlineData(@"\neg \top\land\top", @"\neg \top \wedge \top ", @"\bot ")]
    [InlineData(@"\neg a\lor\neg a", @"\neg a\vee \neg a", @"\neg a")]
    // Test relational operators bind tighter than logical
    [InlineData(@"a=b\land c=d", @"a=b\wedge c=d", @"a=b\wedge c=d")]
    [InlineData(@"a<b\lor c>d", @"a<b\vee c>d", @"a<b\vee c>d")]
    public void LogicalOperatorPrecedence(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"1<x<3", @"1<x<3", @"1<x<3")]
    [InlineData(@"(1<x)<3", @"\left( 1<x\right) <3", @"\left( 1<x\right) <3")]
    [InlineData(@"(1<2)<3", @"\left( 1<2\right) <3", @"\top <3", @"\bot ", @"\bot >3")]
    [InlineData(@"1<(2<3)", @"1<\left( 2<3\right) ", @"1<\top ", @"\bot ", @"1>\bot ")]
    [InlineData(@"1<2<3", @"1<2<3", @"\top ", @"\bot ", @"\bot ")]
    [InlineData(@"3<2<3", @"3<2<3", @"\bot ")]
    [InlineData(@"1<2<1", @"1<2<1", @"\bot ")]
    [InlineData(@"1<1<1", @"1<1<1", @"\bot ", @"\top ")]
    [InlineData(@"1\leq 2<3", @"1\leq 2<3", @"\top ", @"\bot ", @"\bot ")]
    [InlineData(@"3\leq 2<3", @"3\leq 2<3", @"\bot ")]
    [InlineData(@"1\leq 2<1", @"1\leq 2<1", @"\bot ")]
    [InlineData(@"1\leq 1<1", @"1\leq 1<1", @"\bot ", @"\top ", @"\bot ")]
    [InlineData(@"1\leq 1=1", @"1\leq 1=1", @"\top ")]
    [InlineData(@"1\leq 1\geq1", @"1\leq 1\geq 1", @"\top ")]
    public void ChainedComparisons(string latex, string converted, string result, string? eqResult = null, string? geqResult = null) {
      Test(latex, converted, result);
      eqResult ??= result.Replace("<", "=").Replace(@"\leq ", "=");
      Test(latex.Replace("<", "=").Replace(@"\leq ", "="),
           converted.Replace("<", "=").Replace(@"\leq ", "="),
           eqResult);
      Test(latex.Replace("<", ">").Replace(@"\leq ", @"\geq "),
           converted.Replace("<", ">").Replace(@"\leq ", @"\geq "),
           geqResult ?? result.Replace("<", ">").Replace(@"\leq ", @"\geq "));
      Test(latex.Replace("<", @"\neq ").Replace(@"\leq ", @"\neq "),
           converted.Replace("<", @"\neq ").Replace(@"\leq ", @"\neq "),
           eqResult.Replace("=", @"\neq ").Replace(@"\top ", @"|||").Replace(@"\bot ", @"\top ").Replace(@"|||", @"\bot "));
    }
    [Theory]
    [InlineData(@"\mathrm{undefined}", @"\mathrm{undefined}", @"\mathrm{undefined}")]
    [InlineData(@"0\times\infty", @"0\cdot \infty ", @"\mathrm{undefined}")]
    [InlineData(@"\mathrm{undefined}+1", @"\mathrm{undefined}+1", @"\mathrm{undefined}")]
    [InlineData(@"\sin\mathrm{undefined}", @"\sin \left( \mathrm{undefined}\right) ", @"\mathrm{undefined}")]
    public void Undefined(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\left|1\right|", @"\left| 1\right| ", @"1")]
    [InlineData(@"-\left|-1\right|", @"-\left| -1\right| ", @"-1")]
    [InlineData(@"-\operatorname{abs}(-1)", @"-\left| -1\right| ", @"-1")]
    [InlineData(@"-\operatorname{abs}\left|-1\right|", @"-\left| \left| -1\right| \right| ", @"-1")]
    [InlineData(@"-\left|1\right|^2", @"-\left| 1\right| ^2", @"-1")]
    [InlineData(@"\operatorname{sgn}\operatorname{abs} x", @"\operatorname{sgn} \left( \left| x\right| \right) ", @"1")]
    public void Abs(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\lim_{x\to2}x+1", @"\lim _{x\rightarrow 2}x+1", @"3")]
    [InlineData(@"\lim_{x\to2^-}x+1", @"\lim _{x\rightarrow 2^-}x+1", @"3")]
    [InlineData(@"\lim_{x\to2^+}x+1", @"\lim _{x\rightarrow 2^+}x+1", @"3")]
    [InlineData(@"\lim_{x\to\infty}x", @"\lim _{x\rightarrow \infty }x", @"\infty ")]
    [InlineData(@"\lim_{x\to0}\frac1x+1", @"\lim _{x\rightarrow 0}\frac{1}{x}+1", @"\mathrm{undefined}")]
    [InlineData(@"\lim_{x\to0^-}\frac1x+1", @"\lim _{x\rightarrow 0^-}\frac{1}{x}+1", @"-\infty ")]
    [InlineData(@"\lim_{x\to0^+}\frac1x+1", @"\lim _{x\rightarrow 0^+}\frac{1}{x}+1", @"\infty ")]
    [InlineData(@"\lim_{x\to\infty}\frac1x^2x^2+1", @"\lim _{x\rightarrow \infty }\left( \frac{1}{x}\right) ^2x^2+1", @"2")]
    [InlineData(@"\lim_{x\to\infty^-}\frac1x^2x^2+1", @"\lim _{x\rightarrow \infty ^-}\left( \frac{1}{x}\right) ^2x^2+1", @"2")]
    [InlineData(@"\lim_{x\to\infty^+}\frac1x^2x^2+1", @"\lim _{x\rightarrow \infty ^+}\left( \frac{1}{x}\right) ^2x^2+1", @"2")]
    [InlineData(@"\lim_{x\to1+x}x", @"\lim _{x\rightarrow 1+x}x", @"\infty ")]
    [InlineData(@"\lim_{x\to(1+x)}x", @"\lim _{x\rightarrow 1+x}x", @"\infty ")]
    [InlineData(@"\lim_{x\to(1+x)^+}x", @"\lim _{x\rightarrow \left( 1+x\right) ^+}x", @"\infty ")]
    [InlineData(@"\lim_{x\to(1+x)^-}x", @"\lim _{x\rightarrow \left( 1+x\right) ^-}x", @"\infty ")]
    [InlineData(@"\lim_{x\to(y)}(x)y+y", @"\lim _{x\rightarrow y}xy+y", @"y^2+y")]
    [InlineData(@"\lim_{x\to(y)^+}(x)y+y", @"\lim _{x\rightarrow y^+}xy+y", @"y^2+y")]
    [InlineData(@"\lim_{x\to(y)^-}(x)y+y", @"\lim _{x\rightarrow y^-}xy+y", @"y^2+y")]
    [InlineData(@"\lim_{y\to zzz_2}x", @"\lim _{y\rightarrow zzz_2}x", @"x")]
    [InlineData(@"\lim_{y\to zzz_2^-}x", @"\lim _{y\rightarrow \left( zzz_2\right) ^-}x", @"x")]
    [InlineData(@"\lim_{y\to zzz_2^+}x", @"\lim _{y\rightarrow \left( zzz_2\right) ^+}x", @"x")]
    [InlineData(@"\lim_{xyy\to zzz_2}x", @"\lim _{xyy\rightarrow zzz_2}x", @"\lim _{xy^2\rightarrow z^2\cdot z_2}x")]
    [InlineData(@"\lim_{xyy\to zzz_2^-}x", @"\lim _{xyy\rightarrow \left( zzz_2\right) ^-}x", @"\lim _{xy^2\rightarrow \left( z^2\cdot z_2\right) ^-}x")]
    [InlineData(@"\lim_{xyy\to zzz_2^+}x", @"\lim _{xyy\rightarrow \left( zzz_2\right) ^+}x", @"\lim _{xy^2\rightarrow \left( z^2\cdot z_2\right) ^+}x")]
    [InlineData(@"\lim_{\mathrm{xy}\to\mathrm{zz}}x", @"\lim _{\mathrm{xy}\rightarrow \mathrm{zz}}x", @"x")]
    [InlineData(@"\lim_{\mathrm{xy}\to\mathrm{zz}^-}x", @"\lim _{\mathrm{xy}\rightarrow \mathrm{zz^{\mathnormal{-}}}}x", @"x")]
    [InlineData(@"\lim_{\mathrm{xy}\to\mathrm{zz^+}}x", @"\lim _{\mathrm{xy}\rightarrow \mathrm{zz^{\mathnormal{+}}}}x", @"x")]
    [InlineData(@"(\lim_{x\to y}(z)^2)^3", @"\left( \lim _{x\rightarrow y}z^2\right) ^3", @"z^6")]
    public void Limit(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}x}x", @"\frac{\mathrm{d}}{\mathrm{d}x}x", @"1")]
    [InlineData(@"\frac{\mathrm{d}x}{\mathrm{d}x}", @"\frac{\mathrm{d}}{\mathrm{d}x}x", @"1")]
    [InlineData(@"\frac{\mathrm{d}x}{\mathrm{d}x}x", @"\left( \frac{\mathrm{d}}{\mathrm{d}x}x\right) \cdot x", @"x")]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}x}xy+1", @"\frac{\mathrm{d}}{\mathrm{d}x}xy+1", @"1+y")]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}(x)}(x)y+1", @"\frac{\mathrm{d}}{\mathrm{d}x}xy+1", @"1+y")]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}x^2}x^2y+1", @"\frac{\mathrm{d}}{\mathrm{d}\left( x^2\right) }x^2\cdot y+1", @"1+y")]
    [InlineData(@"\frac{\mathrm{d}x^2}{\mathrm{d}x^2}y+1", @"\left( \frac{\mathrm{d}}{\mathrm{d}\left( x^2\right) }x^2\right) \cdot y+1", @"1+y")]
    [InlineData(@"\frac{\mathrm{d}x}{\mathrm{d}x^2}xy+1", @"\left( \frac{\mathrm{d}}{\mathrm{d}\left( x^2\right) }x\right) \cdot xy+1", @"1")]
    [InlineData(@"\frac{\mathrm{d}x}{\mathrm{d}(x^2)}(x)y+1", @"\left( \frac{\mathrm{d}}{\mathrm{d}\left( x^2\right) }x\right) \cdot xy+1", @"1")]
    [InlineData(@"\frac{\mathrm{d}^2}{\mathrm{d}x^2}x^2y+1", @"\frac{\mathrm{d^{\mathnormal{2}}}}{\mathrm{d}x^2}x^2\cdot y+1", @"1+2y")]
    [InlineData(@"\frac{\mathrm{d}^2}{\mathrm{d}(x^2)^2}x^2y+1", @"\frac{\mathrm{d^{\mathnormal{2}}}}{\mathrm{d}\left( x^2\right) ^2}x^2\cdot y+1", @"1")]
    [InlineData(@"\frac{\mathrm{d}^2x}{\mathrm{d}x^2}x^2y+1", @"\left( \frac{\mathrm{d^{\mathnormal{2}}}}{\mathrm{d}x^2}x\right) \cdot x^2\cdot y+1", @"1")]
    [InlineData(@"\frac{\mathrm{d}^2x}{\mathrm{d}(x^2)^2}x^2y+1", @"\left( \frac{\mathrm{d^{\mathnormal{2}}}}{\mathrm{d}\left( x^2\right) ^2}x\right) \cdot x^2\cdot y+1", @"1")]
    [InlineData(@"\frac{\mathrm{d}}{\mathrm{d}x}\lim_{y\to z}xy+x", @"\frac{\mathrm{d}}{\mathrm{d}x}\lim _{y\rightarrow z}xy+x", @"x+z")]
    [InlineData(@"\frac{\mathrm{d}^0x}{\mathrm{d}x^0}y+1", @"\left( \frac{\mathrm{d^{\mathnormal{0}}}}{\mathrm{d}x^0}x\right) \cdot y+1", @"1+xy")]
    [InlineData(@"\frac{\mathrm{d}^{-1}x}{\mathrm{d}x^{-1}}y+1", @"\left( \int x\, \mathrm{d}x\right) \cdot y+1", @"\left( \frac{x^2}{2}+C\right) \cdot y+1")]
    [InlineData(@"\frac\mathrm{dy}\mathrm{dx}\mathrm{dx}", @"\frac{\mathrm{dy}}{\mathrm{dx}}\cdot \mathrm{dx}", @"\mathrm{dy}\quad \mathrm{for}\quad \mathrm{dx}\neq 0")] // upright letters are interpreted together.
    [InlineData(@"\frac\mathrm{d\ y}\mathrm{d\ x}", @"\frac{\mathrm{d}}{\mathrm{d}x}y", @"0")] // spaces are required to separate upright letters.
    [InlineData(@"\frac\mathrm{dx}\mathrm{dx}", @"\frac{\mathrm{dx}}{\mathrm{dx}}", @"1\quad \mathrm{for}\quad \mathrm{dx}\neq 0")]
    public void Derivative(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\int\mathrm{d}x", @"\int 1\, \mathrm{d}x", @"C+x")]
    [InlineData(@"\int\int\mathrm{d}x\mathrm{d}y", @"\int \int 1\, \mathrm{d}x\, \mathrm{d}y", @"C_1+\left( C+x\right) \cdot y")]
    [InlineData(@"(\int\int\mathrm{d}x\mathrm{d}y)", @"\int \int 1\, \mathrm{d}x\, \mathrm{d}y", @"C_1+\left( C+x\right) \cdot y")]
    [InlineData(@"\int\int C\mathrm{d}x\mathrm{d}y", @"\int \int C\, \mathrm{d}x\, \mathrm{d}y", @"\left( C_1+Cx\right) \cdot y+C_2")]
    [InlineData(@"\int\frac\mathrm{d}{\mathrm{d}x}\int C\mathrm{d}x\mathrm{d}y", @"\int \frac{\mathrm{d}}{\mathrm{d}x}\int C\, \mathrm{d}x\, \mathrm{d}y", @"C_1+Cy")]
    [InlineData(@"\int x\,\mathrm{d}x", @"\int x\, \mathrm{d}x", @"\frac{x^2}{2}+C")]
    [InlineData(@"\int x+y\,\mathrm{d}x", @"\int \left( x+y\right) \, \mathrm{d}x", @"\frac{\left( x+y\right) ^2}{2}+C")]
    [InlineData(@"2\int x+y\,\mathrm{d}x\cdot 3", @"2\left( \int \left( x+y\right) \, \mathrm{d}x\right) \cdot 3", @"6\left( C+\frac{\left( x+y\right) ^2}{2}\right) ")]
    [InlineData(@"2+\int\sin x+y\,\mathrm{d}\sin x+3", @"2+\int \left( \sin \left( x\right) +y\right) \, \mathrm{d}\left( \sin \left( x\right) \right) +3", @"5+\frac{\left( \sin \left( x\right) +y\right) ^2}{2}+C")]
    [InlineData(@"2+\int xy+z\,\mathrm{d}xy\cdot 3", @"2+\left( \int \left( xy+z\right) \, \mathrm{d}\left( xy\right) \right) \cdot 3", @"2+\left( \frac{\left( xy+z\right) ^2}{2}+C\right) \cdot 3")]
    [InlineData(@"\int_0^1\mathrm{d}x", @"\int _0^11\, \mathrm{d}x", @"1")]
    [InlineData(@"\int_{10}^{11}\mathrm{d}x", @"\int _{10}^{11}1\, \mathrm{d}x", @"1")]
    [InlineData(@"\int_{10}^{11}x\mathrm{d}x", @"\int _{10}^{11}x\, \mathrm{d}x", @"\frac{21}{2}")]
    [InlineData(@"\int_{-\infty}^\infty\frac1{x^2+1}\mathrm{d}x", @"\int _{-\infty }^{\infty }\frac{1}{x^2+1}\, \mathrm{d}x", @"\mathrm{\pi }")]
    public void Integral(string latex, string converted, string result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"x\mathrm{for}y", @"x\quad \mathrm{for}\quad y", @"x\quad \mathrm{for}\quad y")]
    [InlineData(@"x\quad \mathrm{for}\quad y", @"x\quad \mathrm{for}\quad y", @"x\quad \mathrm{for}\quad y")]
    [InlineData(@"(x\mathrm{for}y)\mathrm{for}z", @"x\quad \mathrm{for}\quad y\quad \mathrm{for}\quad z", @"x\quad \mathrm{for}\quad y\wedge z")]
    [InlineData(@"x\mathrm{for}(y\mathrm{for}z)", @"x\quad \mathrm{for}\quad y\quad \mathrm{for}\quad z", @"x\quad \mathrm{for}\quad y\wedge z")]
    [InlineData(@"x\mathrm{for}y\mathrm{for}z", @"x\quad \mathrm{for}\quad y\quad \mathrm{for}\quad z", @"x\quad \mathrm{for}\quad y\wedge z")]
    [InlineData(@"x\mathrm{for}y,y\mathrm{for}z,z\mathrm{for}a\mathrm{for}b", @"x\quad \mathrm{for}\quad y,y\quad \mathrm{for}\quad z,z\quad \mathrm{for}\quad a\quad \mathrm{for}\quad b", null)]
    [InlineData(@"x=2=y\mathrm{for}x\leftrightarrow y", @"x=2=y\quad \mathrm{for}\quad \neg \left( x\veebar y\right) ", @"x=2=y\quad \mathrm{for}\quad \neg \left( x\veebar y\right) ")]
    public void Provided(string latex, string converted, string? result) => Test(latex, converted, result);
    [Theory]
    [InlineData(@"\begin{cases}x+1\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{otherwise}\end{array}\right. ",
                @"1+x")]
    [InlineData(@"\begin{cases}x+1\\x-1\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{otherwise}\\ \textstyle x-1&\textstyle \mathrm{otherwise}\end{array}\right. ",
                @"1+x")]
    [InlineData(@"\begin{cases}x+1&\mathrm{otherwise}\\x-1\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{otherwise}\\ \textstyle x-1&\textstyle \mathrm{otherwise}\end{array}\right. ",
                @"1+x")]
    [InlineData(@"\begin{cases}x+1&\top\\x-1&\mathrm{otherwise}\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{otherwise}\\ \textstyle x-1&\textstyle \mathrm{otherwise}\end{array}\right. ",
                @"1+x")]
    [InlineData(@"\begin{cases}x+1&\mathrm{otherwise}\\x-1&\mathrm{for}\top\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{otherwise}\\ \textstyle x-1&\textstyle \mathrm{otherwise}\end{array}\right. ",
                @"1+x")]
    [InlineData(@"\begin{cases}x+1 & x<0\\x-1 & x\geq0\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{for\  }x<0\\ \textstyle x-1&\textstyle \mathrm{for\  }x\geq 0\end{array}\right. ",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{for\  }x<0\\ \textstyle x-1&\textstyle \mathrm{for\  }x\geq 0\end{array}\right. ")]
    [InlineData(@"\begin{cases}x+1 & \mathrm{for}\ x<0\\x-1 & \mathrm{for}\ x\geq0\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{for\  }x<0\\ \textstyle x-1&\textstyle \mathrm{for\  }x\geq 0\end{array}\right. ",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{for\  }x<0\\ \textstyle x-1&\textstyle \mathrm{for\  }x\geq 0\end{array}\right. ")]
    [InlineData(@"\begin{cases}x+1 & \mathrm{for} x<0\mathrm{for} y\\x-1 & \mathrm{for}\ x\geq0\mathrm{for} y\end{cases}",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{for\  }\left( x<0\quad \mathrm{for}\quad y\right) \\ \textstyle x-1&\textstyle \mathrm{for\  }\left( x\geq 0\quad \mathrm{for}\quad y\right) \end{array}\right. ",
                @"\left\{ \, \begin{array}{ll}\textstyle x+1&\textstyle \mathrm{for\  }\left( x<0\quad \mathrm{for}\quad y\right) \\ \textstyle x-1&\textstyle \mathrm{for\  }\left( x\geq 0\quad \mathrm{for}\quad y\right) \end{array}\right. ")]
    public void Piecewise(string latex, string converted, string result) => Test(latex, converted, result);
  }
}